'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){async function a(a,b){let c,d=2;return c=s.isGameApp(a)?await q(a):await p(a),d=c.subPackages?b.setting.MaxSubpackageFullCodeSize||b.setting.MaxCodeSize:b.setting.MaxCodeSize,d}async function b(a){const b=`upload-code-${+new Date}`;try{a.showProgress&&v.get().add({id:b,name:r.config.UPLOAD_CODE,successName:`${r.config.UPLOAD_CODE}${r.config.PUNCTUATION_SEPARATOR}${r.config.DONE}`,failName:`${r.config.UPLOAD_CODE}${r.config.PUNCTUATION_SEPARATOR}${r.config.FAILED}`,type:'upload',progressIndeterminate:!0});const d=await c(_extends({},a,{progressTaskId:b}));if(a.showProgress){if(d&&d.wxpkg_size){const a=`${r.config.UPLOAD_SIZE_IN_BACKEND}${r.config.COLON}${r.config.PUNCTUATION_SEPARATOR}${C.getFormattedSize(d.wxpkg_size)}`;v.get().updateDetails(b,a)}v.get().markSuccess(b)}return d}catch(c){throw a.showProgress&&(v.get().updateDetails(b,c.toString()),v.get().markFail(b)),c}}async function c(b){let c,e,j;b.tempProject?(c=b.tempProject.attr,e=b.tempProject):(c=s.getCurrentConfig(),e=s.getCurrent());try{j=await a(e,c)}catch(a){try{j=c.setting.MaxCodeSize}catch(a){j=2}}const p=1024*j,t=b.onProgressUpdate||E,u=b.onFilesMissing||E;t('buildstart',r.config.COMPILING_CODE);const v=await m(e,{noCompile:!0,onProgressUpdate:t,onFilesIgnored:b.onFilesIgnored});t('globfiles',r.config.COMPARING_FILE_LIST);const C=['**/.git/**','.git/**/*','**/.svn/**','.svn/**/*','.DS_Store','**/.DS_Store'];'plugin'===e.compileType&&C.push('doc/**/*');let D=await F('**',{nodir:!0,ignore:C,nosort:!0,strict:!1,silent:!0,cwd:v,absolute:!1,mark:!0,dot:!0});const G=A.getFileNameMapping(),H=B.invert(G);D=D.map((a)=>{return'string'==typeof H[a]?H[a]:a});let I=(e.packOptions||{}).ignore||[];b.remoteDebug&&b.noMaps&&(I=[...I,{type:'suffix',value:'.map'}]);const J=[];for(const a of D){const b=f.posix.join(e.miniprogramRoot||'',a);if(!z.isFileIgnored(a,I)&&!z.isIngoreByProjectConfig(e,b))J.push(a);else try{const b='string'==typeof G[a]?G[a]:a;d.unlinkSync(f.join(v,b))}catch(a){console.error(a)}}D=J;let K=e.projectpath;'plugin'===e.compileType?K=e.projectpath:e.miniprogramRoot&&(K=f.posix.join(e.projectpath,e.miniprogramRoot));const L=await F('**',{nodir:!0,ignore:C,nosort:!0,strict:!1,silent:!0,cwd:K,absolute:!1,mark:!0,dot:!0}),M=L.filter((a)=>0>D.findIndex((b)=>b===a))||[],N=(await F('**/node_modules/',{nosort:!0,strict:!1,silent:!0,cwd:K,absolute:!1,mark:!0,dot:!0}))||[];M.push(...N),u(M),t('buildend',r.config.CODE_COMPILATION_COMPLETED),t('packstart',r.config.PACKING);const O=f.join(w,`${+new Date}.wx`),P=await n(v,O);d.unlink(O,()=>{}),t('packend',r.config.PACK_COMPLETED),t('uploadstart',r.config.UPLOADING);const Q=P.data,R=P.pDestPath;let S=P.totalSize;if(s.isGameApp()){const a=await q(e);if(a.loadingImageInfo&&a.loadingImageInfo.path){const b=d.statSync(f.join(v,a.loadingImageInfo.path));S-=b.size}}h(v,()=>{});const T=parseInt(S/1024);if(T>p){const a=new Error(r.config.CODE_SIZE_EXCEED.format([T,p]));throw a.code=l.CODE_SIZE_EXCEED,a}let U;const V=global.appConfig.isBeta;if(b.test){if(o[`last-up-test-${e.projectid}`]=T,U=V?`${k.testSourceNewFeatureURL}?gzip=1`:`${k.testSourceURL}?gzip=1`,b.remoteDebug){let a=b.cdpEnabled?4:1;'ios'===b.remoteDebugLocal?a=2:'android'===b.remoteDebugLocal&&(a=3);const c=b.remoteProxyPort||0,d=b.disableUrlCheck?1:0;U=`${k.testSourceURL}?gzip=1&open_remote=yes&remote_network_type=${a}&remote_proxy_port=${c}&disable_url_check=${d}&remote_support_compress_algo=1`}b.autoPreview&&!b.remoteDebug&&(U+='&hot_update=yes');const{page:a,query:c,searchQuery:d,boxQI:f}=b;if(a){const b=encodeURIComponent(`${a}?${c}`);U=`${U}&path=${b}`}if(e.attr.gameApp&&c){const a=encodeURIComponent(`?${c}`);U=`${U}&path=${a}`}if(d&&(U=`${U}&search_query=${encodeURIComponent(d)}`),f){U=`${U}&search_extInfo=${encodeURIComponent(JSON.stringify({box_qi:f}))}`}}else{o[`last-up-load-${e.projectid}`]=T;const a=encodeURIComponent(b.desc),c=encodeURIComponent(b.version),d=encodeURIComponent(b.uuid);U=V?`${k.commitSourceNewFeatureURL}?user-version=${c}&user-desc=${a}&uuid=${d}&gzip=1`:`${k.commitSourceURL}?user-version=${c}&user-desc=${a}&uuid=${d}&gzip=1`}const W=g.gzipSync(Q),X=1*new Date,Y=b.tempProject?{url:`${U}&appid=${b.tempProject.appid}&devplugin=${e.compileType==y.plugin?1:0}`,method:'post',body:W,needToken:1}:{url:`${U}&devplugin=${e.compileType==y.plugin?1:0}`,method:'post',body:W,needToken:1,needAppID:1};b.tempProject&&b.tempProject.attr&&b.tempProject.attr.platform&&(Y.url+='&platform=1',b.tempProject.runtimeAttr&&b.tempProject.runtimeAttr.isExtAppId&&(Y.url+=`&ext_appid=${b.tempProject.runtimeAttr.appid||''}`));const{body:Z}=await i(Y),$=1*new Date;return x(b.test?'client_test_source_time':'client_commit_source_time',e.appid,`${$-X}`),t('uploadend',r.config.UPLOAD_COMPLETED),Z}const d=require('fs'),e=require('glob'),f=require('path'),g=require('zlib'),h=require('rmdir'),i=require('./15ba1827c7f6564a45df6bd44da3a977.js'),j=require('./92320c1386e6db6a6f2556736a9bc280.js'),k=require('./f171257bbcaef547a3cf27266ccb0db2.js'),l=require('./949d8235c744ced2a80121e4dba34c28.js'),m=require('./911222a6723da8db7ca8a8e3689591e1.js'),n=require('./e5fa35c3c8e81bc6466b4b8eb436113b.js'),o=require('./84858de8a097c9cf84ff2c2e3d86e2a9.js'),p=require('./1dea83a77e99a7c94f6b6f01f5c175b0.js'),q=require('./1bd2563d13db26950ae47494b2c34454.js'),r=require('./common/locales/index.js'),s=require('./3bfffbe88b3d923921f851c0697974fe.js'),t=require('./72653d4b93cdd7443296229431a7aa9a.js'),u=require('./d28a711224425b00101635efe1034c99.js'),v=require('./664c85134de31b9a04ff1f03a1492daf.js'),w=j.Weappdest,x=require('./da7c31daaf542cf1796023d8e344b98a.js'),y=require('./9fdd4ac31a05c27355910f0d74accd4c.js'),z=require('./1c8a8c710417d102ab574145dc51b4b0.js'),A=require('./890791d99e6d0eadf6a5a73d8d797338.js'),B=require('lodash'),C=require('./84b183688a46c9e2626d3e6f83365e13.js'),D=require('./a932aac82ac84fc9c6c92194bd88204e.js'),E=()=>{},F=function(a,b){return new Promise((c)=>{e(a,b,(a,b)=>{a?c([]):c(b)})})};module.exports=async function(a){return D.enqueueBuildTask(b.bind(null,a),D.buildType.upload)}}(require('lazyload'),require);