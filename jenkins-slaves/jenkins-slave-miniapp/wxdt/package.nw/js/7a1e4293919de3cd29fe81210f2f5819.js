'use strict';!function(require,directRequire){async function a(){try{const a=await q({url:r.wxGitUpdate,needToken:1,needCheckErrCode:1,needCheckStatusCode:1,needParse:1,needAppID:1});console.log('wxgit update result',a)}catch(a){console.error('wxgit auto update fail',a)}}function b(){const a=nw.Window.get();a.setMinimumSize(1064,700)}function c(){const a=nw.Window.get();a.setMinimumSize(g.MIN_MAIN_WINDOW_WIDTH,g.MIN_MAIN_WINDOW_HEIGHT)}const d=require('react'),e=require('child_process'),f=require('./875171e7b864aa58d026d4fa0999fbd1.js'),g=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),h=require('./ff946754202ecf377034d29daac7c8d9.js'),i=require('./f15811258ec83bc7d2978d66ddd5ed8a.js'),j=require('./437e6043fc662374e4f1c2330516ac40.js'),k=require('./3ee3c042cc6a0925a86761ac0af92c10.js'),l=require('./41168dca39589e852da6631126d0f94d.js'),m=require('git-url-parse'),n=require('./3892cb9d0783075a973c350c41401370.js'),o=require('./da7c31daaf542cf1796023d8e344b98a.js'),p=require('./common/locales/index.js'),q=require('./15ba1827c7f6564a45df6bd44da3a977.js'),r=require('./f171257bbcaef547a3cf27266ccb0db2.js'),s='darwin'===process.platform;module.exports=class extends d.Component{constructor(c){super(c),this.state={animated:!1,show:c.panelShow},b(),c.canUseWxGit&&a()}componentWillReceiveProps(a){if(a.panelShow!==this.props.panelShow||a.closeTs!==this.props.closeTs){const d=a.panelShow&&a.closeTs===this.props.closeTs;this.setState({show:d}),d?b():c()}}async onMessage(a){try{const b=await l({taskName:'gitassistant',dataStr:JSON.stringify(a),maxTimeout:60000,useBackup:!!s,forceBackup:!!s,downgrade:!0});b.error&&console.error(b.error),k.send(b)}catch(a){console.error(a)}}componentDidMount(){o('git_manager_open',!0),this.mountWebview(),k.ready=!0,k.register(this._onMessageFn=this.onMessage.bind(this))}componentWillUnmount(){c(),this.webview&&(i.disable(this.webview),this.webview.removeEventListener('dialog',this._promptListener),this.webview.remove(),this.webview=null),this.freeAll(),k.ready=!1,k.unRegister(this._onMessageFn),clearTimeout(this._removeWebviewMaskTimer)}freeAll(){s?l({taskName:'gitassistant',dataStr:JSON.stringify({id:-1,method:'git.freeAll',params:{}}),maxTimeout:10000,useBackup:!!s,forceBackup:!!s,downgrade:!0}).then(console.log,console.error):l.stopImmediately&&l.stopImmediately()}handleCloseClick(){this.close()}close(){this.setState({show:!1}),c()}onAnimationOut(){this.props.togglePanelShow(!1),c()}onAnimationIn(){}promptListener(a){const b=a.messageType;let c=a.messageText;const d=a.dialog;if('prompt'===b&&d&&c)if(c.startsWith('getproxyforurl:')){a.preventDefault(),c=c.replace(/^getproxyforurl\:/,'');try{const a=m(c);a&&'string'==typeof a.resource&&'string'==typeof a.protocol&&(c=`${a.protocol}://${a.resource}`);const b=j.getProxyForURL(c);d.ok&&d.ok(JSON.stringify({result:b}))}catch(a){d.ok&&d.ok(JSON.stringify({result:null}))}}else if(c.startsWith('openterminal:'))a.preventDefault(),d.ok&&d.ok(),c=c.replace('openterminal:',''),n(c);else if(c.startsWith('opentgit:')){if(a.preventDefault(),c=c.replace('opentgit:',''),d.ok&&d.ok(),'document'===c)try{nw.Shell.openExternal('https://developers.weixin.qq.com/miniprogram/dev/qcloud/tgit.html')}catch(a){console.error(a)}else this.props.toolbarActions.jumpTGit();}else if(c.startsWith('openwxgit:'))a.preventDefault(),c=c.replace('opentgit:',''),d.ok&&d.ok(),this.jumpWxGit();else if(c.startsWith('git:'))a.preventDefault(),c=c.replace('git:',''),d.ok&&d.ok(),'fc'===c?this.freeAll():'reload'===c?this.reloadWebview():void 0;else if(c.startsWith('ideexchange:')){a.preventDefault(),c=c.replace('ideexchange:',''),d.ok&&d.ok();const b=JSON.parse(c);this.onIdeExchange(b.id,b.command,b.data)}else if(c.startsWith('openurl:')){a.preventDefault(),c=c.replace('openurl:',''),d.ok&&d.ok();try{nw.Shell.openExternal(c)}catch(a){console.error(a)}}}reloadWebview(){const a=this.props,b=this.webview;if(!b)return;const c=[a.canUseWxGit?1:0],d={isdev:(global.appConfig||{}).isDev?'yes':'',_random:Math.random()+'',projectpath:(this.props.project||{}).projectpath||'',ws:`ws://127.0.0.1:${global.gitMessagePort||global.messageCenterPort}`,wsprotocol:`GITMANAGER#${h.getToken('GITMANAGER')}#`,logined:'SUCCESS'===a.user.loginStatus?'yes':'no',openid:a.user.openid||'',nickname:a.user.nickName||'',hl:p.getLocale()||'zh',theme:'dark'===a.theme?'dark':'white',extensions:c.join(','),hastgit:a.hasTGit?'yes':'',issandbox:a.isSandbox?'yes':''};let e='';for(const a in d)d.hasOwnProperty(a)&&void 0!==d[a]&&(e+=`${a}=${encodeURIComponent(d[a])}&`);b.src='html/gitmanager.html?'+e}wxGitOpenWeb(){this.props.toolbarActions.jumpWXGit()}async onIdeExchange(a,b){let c={};'wxgit_get_repositories'===b?c=await this.wxGitGetRepositories():'wxgit_open_web'===b&&this.wxGitOpenWeb();let d=encodeURIComponent(JSON.stringify(c));this.webview&&this.webview.executeScript({code:`;(function() {
        var s = document.createElement('script')
        var sid = '__idexh__'
        s.id = sid
        s.text = \`;(function(window, document){
          if (typeof window.$ideExchange === 'function') {
            window.$ideExchange('${a}', decodeURIComponent('${d}'))
          }
          var scriptEl = document.getElementById('\${sid}')
          if (scriptEl) {
            scriptEl.remove()
            scriptEl = null
          }
          //# sourceURL=[__ideExchangeHelper__]
        })(window, document);\`
        var node = document.head || document.body || document.documentElement
        if (node) {
          node.appendChild(s)
        }
        s = null
      })();`})}async wxGitGetRepositories(){return new Promise((a)=>{q({url:r.wxGitGetRepositories,needToken:1,needCheckErrCode:1,needCheckStatusCode:1,needParse:1,needAppID:1}).then((b)=>{const c=(b||{}).body;if(!c||!c.data)return a({error:'Empty data retrieved.'});if('string'!=typeof c.data)return a({error:'data type invalid '+Object.prototype.toString.call(c.data)});let d;try{if(d=JSON.parse(c.data.trim())||{},!Array.isArray(d)&&(d=d.projects,!Array.isArray(d)))throw new Error('Invalid data retreived. '+c.data)}catch(b){return a({error:b&&b.toString?b.toString():`${b}`})}a({error:null,repos:d})},(b)=>{a({error:b&&b.toString?b.toString():`${b}`})})})}jumpWxGit(){this.props.toolbarActions.jumpWXGit()}mountWebview(){this.props;if(!this.webview&&this.webviewContainer){this.webview=document.createElement('webview');const a=this.webview;a.setAttribute('partition','persist:gitmanager'),a.setAttribute('data-plugin-id','gitmanager'),a.setAttribute('tabIndex','-1'),a.style.flex='1',this.reloadWebview(),i.enable(a),requestAnimationFrame(()=>{this.webviewContainer.appendChild(a),a.addEventListener('dialog',this._promptListener=this.promptListener.bind(this))})}this.webviewMask&&(this._removeWebviewMaskTimer=setTimeout(()=>{this.webviewMask&&requestAnimationFrame(()=>{this.webviewMask.style.opacity=0}),setTimeout(()=>requestAnimationFrame(()=>{this.webviewMask&&this.webviewMask.remove(),this.webviewMask=null,document.activeElement&&document.activeElement.blur&&document.activeElement.blur()}),1e3)},800))}render(){const a=this.props.theme;return d.createElement('div',null,d.createElement('div',{className:'ui-mask ui-mask-transparent',onClick:this.handleCloseClick.bind(this)}),d.createElement(f,{onAnimationIn:this.onAnimationIn.bind(this),onAnimationOut:this.onAnimationOut.bind(this),show:this.state.show,style:'dark'===a?{width:'90%',willChange:'transform',minWidth:'1024px',marginLeft:'calc(-90% / 2)',height:'95%',minHeight:'600px',boxShadow:'rgba(0, 0, 0, 0.8) 0px 5px 50px 5px',borderBottomLeftRadius:'3px',borderBottomRightRadius:'3px',border:'1px solid rgb(89, 89, 89)',background:'rgb(74, 74, 74)',animation:this.state.show?'pull-down cubic-bezier(0.165, 0.84, 0.44, 1) 0.4s':'pull-up cubic-bezier(0.165, 0.84, 0.44, 1) 0.2s'}:{width:'90%',willChange:'transform',minWidth:'1024px',marginLeft:'calc(-90% / 2)',height:'95%',minHeight:'600px',boxShadow:'inset 0 0 0 0.5px rgba(0, 0, 0, 0.3), 0 5px 50px 0 rgba(0, 0, 0, 0.3)',borderBottomLeftRadius:'3px',borderBottomRightRadius:'3px',border:'1px solid #d6d6d6',background:'#FFF',animation:this.state.show?'pull-down cubic-bezier(0.165, 0.84, 0.44, 1) 0.4s':'pull-up cubic-bezier(0.165, 0.84, 0.44, 1) 0.2s'},inClassName:'ui-animate-pull-down ui-dialog',outClassName:'ui-animate-pull-up ui-dialog'},d.createElement('div',{style:{flex:1,display:'flex',position:'relative'},ref:(a)=>this.webviewContainer=a},d.createElement('div',{ref:(a)=>this.webviewMask=a,style:'dark'===a?{position:'absolute',left:0,top:0,width:'100%',height:'100%',zIndex:999999,background:'rgb(74, 74, 74)',opacity:1,transition:'all .2s',willChange:'opacity',pointerEvents:'none'}:{position:'absolute',left:0,top:0,width:'100%',height:'100%',zIndex:999999,background:'rgb(252, 252, 252)',opacity:1,transition:'all .2s',willChange:'opacity',pointerEvents:'none'}},d.createElement('i',{className:'ui-icon-spinner',style:{width:'100px',height:'100px',display:'block',margin:'100px auto'}})))))}}}(require('lazyload'),require);