'use strict';!function(require,directRequire){const a=require('react'),b=require('redux'),c=require('moment'),d=require('./f0466135fc8b3a662084784e5f4ac792.js'),e=require('./eadce02c750c875a10680bcfedadec88.js'),f=require('./9fdd4ac31a05c27355910f0d74accd4c.js'),g=require('./1fcc6bd55b687d154a4247e57fe3011d.js'),h=require('./2f0aa63ae61d48294b5e9927ab57e1a4.js'),i=require('./fc137838572a83604db39acff8e909e0.js'),j=require('./cc2c2970ff81ae4a83123e81ee123da2.js'),k=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),l=require('./63f52c9055d92f52ca0510da7d3dcadb.js'),m=require('./a8c87029da0fa06e986298d447ab0fe2.js'),n=require('./e4d68def70709dc877cb2ba5bdad18cb.js'),o=require('./e98c60a262d8d98e69e574a9d12a21df.js'),p=require('./9355620dfff47077fc5946269d43cd4d.js'),q=require('./949d8235c744ced2a80121e4dba34c28.js'),{getAvailablePort:r}=require('./84b183688a46c9e2626d3e6f83365e13.js'),s=require('./common/locales/index.js'),t=(()=>{let a;return async function(b=!1){return!b&&a?Promise.resolve(a):(a=await r(),Promise.resolve(a))}})(),{connect:u}=require('react-redux');class v extends a.Component{constructor(a){super(a),this.state={loading:!0,show:a.show,src:'',tipsShow:!1,previewToolShown:!1,filesIgnored:[],remoteDebugEvents:[],filesMissing:[]},this.previewTimer=null,this._mounted=!1}componentDidMount(){this._mounted=!0,(!this.props.compilerSettings.autoPreview||this.props.remoteDebug)&&this.loadQRCode(),this._cancalLocaleListener=s.onChangeLocale(()=>this.forceUpdate())}loadQRCode(){this.setState({loading:!0,filesIgnored:[],filesMissing:[],tipsShow:!1,stage:null,src:'',remoteDebugStatus:null,remoteDebugEvents:[]}),this.previewTimer=setTimeout(async()=>{let a;const b=(a=null,b='')=>{console.log('progress stage',a,'detailedText',b),this.setState({progressDetailedText:b,stage:a})},e=this.props,g=e.project;if(g&&g.setting&&g.setting.scriptsEnable&&g.scripts&&g.scripts.beforePreview){b('custombeforepreview',s.config.CONSOLE_PREPROCESS_RUNNING),e.consoleActions.clear(),e.consoleActions.log(s.config.CONSOLE_PREPROCESS_START);try{await n.run({command:g.scripts.beforePreview,options:{cwd:g.projectpath,shell:!0},stderr:e.consoleActions.error,stdout:e.consoleActions.log})}catch(a){return e.consoleActions.error(s.config.CONSOLE_PREPROCESS_ERROR),this.hideQrCodeWin(),void this.props.showError(new Error(s.config.CONSOLE_PREPROCESS_ERROR))}b('custombeforepreview',s.config.CONSOLE_PREPROCESS_SUCCESS)}const h=e.remoteDebug&&global.l?await t(!0):void 0,i={test:!0,onProgressUpdate:b,onFilesIgnored:(a=[])=>{this.setState({filesIgnored:a})},onFilesMissing:(a=[])=>{this.setState({filesMissing:a})},remoteDebug:e.remoteDebug,remoteDebugLocal:global.l,remoteProxyPort:h,disableUrlCheck:e.remoteDebugWindow.disableUrlCheck,autoPreview:e.compilerSettings.autoPreview,cdpEnabled:'game'===g.compileType,noMaps:e.remoteDebugWindow.noMaps};try{const b=this.props.project,c=b.compileType,d=b.condiction[c];a=d.list[d.current],c==f.search?a&&(i.searchQuery=a.customQuery||a.query,i.boxQI=a.customQuery?'':a.boxQI):(c==f.weapp||c==f.plugin)&&(i.page=a?a.pathName:this.props.appConfig.pages[0],i.query=a?a.query:''),b.attr.gameApp&&(i.query=a?a.query:'')}catch(a){}d(i).then(async(a)=>{if(this._mounted){const d=+new Date+1500000,f=c(d).calendar(),g=c(new Date).calendar();if(e.remoteDebug){const{wxpkg_info:c='',room_id:d='',qrcode_img:f='',username:g=''}=a;if(!c||!d||!f)throw new Error('invalid request');let i=await l.init(e.project,{wxpkg_info:c,room_id:d,username:g,appid:e.project.appid},{usingLocalStorage:e.remoteDebugWindow.usingLocalStorage,remoteDebugLocal:global.l,clientProxyPort:h,onStatusUpdate:(b,c)=>{this.state.show&&(c&&i&&i.url?(this.props.windowActions.setRemoteDebugWindow({show:!0,inspectUrl:i.url,serverInfo:a}),this.hideQrCodeWin()):this.setState({remoteDebugStatus:b}))},onProgressUpdate:b,onEvent:(a)=>{this.state.show&&this.setState({remoteDebugEvents:(this.state.remoteDebugEvents||[]).concat(a)})},isGame:'game'===e.project.compileType})}this.setState({generateTime:g,qrcode_time:f,src:`data:image/png;base64,${a.qrcode_img}`,loading:!1,progressDetailedText:'',stage:null}),this.props.setPkgSize({preview:a.wxpkg_size,previewSubpackages:a.subpackage_info,lastPreviewTime:+new Date})}}).catch((a)=>{this._mounted&&(a.code===q.FILE_FLAT_ERR?this.props.setConfirmInfo({show:!0,type:'error',title:s.config.COULD_NOT_USE_CODE_PROTECT,content:a.message,showCancel:!0,showConfirm:!0,cancelText:s.config.CLOSE,confirmText:s.config.READ_DOCUMENTATION,callback:(a)=>{a&&nw.Shell.openExternal('https://developers.weixin.qq.com/miniprogram/dev/devtools/project.html#%E4%BB%A3%E7%A0%81%E4%BF%9D%E6%8A%A4')}}):this.props.showError(a instanceof Error?a:new Error(a)),this.hideQrCodeWin())})})}componentWillReceiveProps(a){a.show!=this.props.show&&this.setState({show:a.show}),a.show&&a.remoteDebug&&a.timeStamp!==this.props.timeStamp?this.loadQRCode():a.show&&!this.props.compilerSettings.autoPreview&&!a.remoteDebug&&a.timeStamp!==this.props.timeStamp&&this.loadQRCode()}componentWillUnmount(){this._mounted=!1,clearTimeout(this.previewTimer),n.abort(),this.props.remoteDebug&&!this.props.remoteDebugWindow.show&&(null!==this.state.remoteDebugStatus&&l.destroy(),this.props.project.projectid===this.props.remoteDebugWindow.debuggingProjectId&&this.props.windowActions.setRemoteDebugWindow({debuggingProjectId:null})),this._cancalLocaleListener()}hideQrCodeWin(){this._mounted&&(this.setState({show:!1}),this.props.toggleClickKey(e.NONE))}onHandleClick(a){a.stopPropagation()}onCopyClick(a,b){b.stopPropagation();let c=this.imgdom;'preview'===a&&(c=this.previewImgDom);const{left:d,top:e,height:f,width:g}=c.getBoundingClientRect(),h=()=>{const a=global.windowMap.get('MAIN'),b=a.window.document.body.offsetWidth;a.capturePage((a)=>{const h=document.createElement('canvas'),c=h.getContext('2d');h.height=f,h.width=g;const i=new Image;i.onload=()=>{const a=i.width/b;c.drawImage(i,d*a,e*a+5,g*a,f*a-5,0,0,g,f);const j=nw.Clipboard.get();j.set(h.toDataURL(),'png'),this.props.showSuccessTip(s.config.CONSOLE_COPY_SUCCESS)},i.src=a},{format:'png',datatype:'datauri'})};this._blinkTimeout||(c.style.opacity=0.6,this._blinkTimeout=setTimeout(()=>{c.style.opacity=1,this._blinkTimeout=null,setTimeout(()=>h(),20)},200))}handleIconAskClick(a){a.stopPropagation();try{nw.Shell.openExternal('https://developers.weixin.qq.com/miniprogram/dev/devtools/mydev.html')}catch(a){console.warn('open external failed.')}}handleWarningAskClick(a){a.stopPropagation();try{nw.Shell.openExternal('https://developers.weixin.qq.com/miniprogram/dev/devtools/debug.html#%E7%BC%96%E8%AF%91%E5%BC%82%E5%B8%B8%E4%BF%A1%E6%81%AF')}catch(a){console.warn('open external failed.')}}showScanCode(a){a.stopPropagation(),this.setState({previewToolShown:!1})}showPreviewTool(a){a.stopPropagation(),this.setState({previewToolShown:!0})}handleTipsClick(a){a.stopPropagation();const b=this.state.tipsShow,c=this.props.top+20;this.setState({tipsShow:!b,tipsTop:c})}handleTipsLinkClick(a){a.stopPropagation();try{nw.Shell.openExternal('https://developers.weixin.qq.com/blogdetail?action=get_post_info&docid=000e0696f084e0b0f21613f6a51804')}catch(a){console.warn('open external failed.')}}handleAutoPreviewClick(a){a===!!this.props.compilerSettings.autoPreview||(this.props.updateIDESetting('compiler','autoPreview',a),a?this.props.autoPreview():this.loadQRCode())}handleTriggerAutoPreviewClick(){this.props.autoPreview()}render(){const b=this.props,c=b.compilerSettings.autoPreview,d=b.remoteDebug,e='game'===b.project.compileType,f=d?a.createElement('h4',{className:'previewer-header-active'},s.config.QR_CODE_REMOTE_DEBUG):c?[a.createElement('h4',{key:'scanQRCode',onClick:this.handleAutoPreviewClick.bind(this,!1)},s.config.QR_CODE_PREVIEW),a.createElement('h4',{key:'autoPreview',className:'previewer-header-active'},s.config.AUTO_PREVIEW)]:[a.createElement('h4',{key:'scanQRCode',className:'previewer-header-active'},s.config.QR_CODE_PREVIEW),a.createElement('h4',{key:'autoPreview',onClick:this.handleAutoPreviewClick.bind(this,!0)},s.config.AUTO_PREVIEW)];return a.createElement('div',null,a.createElement('div',{className:'preview-group',style:{position:'absolute',top:this.props.top,left:this.props.left,display:this.state.show?'':'none',width:'262'}},a.createElement('div',{className:'preview-item'},a.createElement('div',{className:'ui-popover',style:{position:'relative',width:'262'},onClick:this.onHandleClick.bind(this)},a.createElement('div',{className:'previewer'},a.createElement('div',{className:'previewer-header',onClick:this.showScanCode.bind(this),style:{cursor:'pointer'}},f),' ',a.createElement('div',{ref:(a)=>this.imgdom=a,style:{position:'relative',display:c&&!d?'none':''}},a.createElement('div',{className:'previewer-body',style:this.state.previewToolShown?{display:'none'}:{}},a.createElement('div',{className:'previewer-qrcode'},a.createElement('div',{className:'preview-qrcode-title',style:this.state.loading||b.remoteDebug?{display:'none'}:{}},a.createElement('p',null,s.config.PREVIEW_QR_CODE_TITLE.format([this.props.nickName,this.state.generateTime||s.config.UNKNOWN_TIME]))),b.authQY?a.createElement('div',{className:'preview-qrcode-title',style:this.state.loading||b.remoteDebug?{display:'none'}:{}},a.createElement('p',null,s.config.WXWORK_SCAN_QR_CODE)):null,!this.state.loading&&0<(this.state.filesIgnored||[]).length+(this.state.filesMissing||[]).length&&a.createElement('p',{style:{fontWeight:600,marginBottom:'10px',textAlign:'center'}},a.createElement('a',{style:{color:'#586c94'},onClick:this.handleTipsClick.bind(this)},s.config.COMPILE_EXCEPTION,(this.state.filesIgnored||[]).length+(this.state.filesMissing||[]).length)),d&&e&&this.state.src&&!this.state.loading?a.createElement('div',{className:'preview-qrcode-tips'},a.createElement('p',null,s.config.PREVIEW_QR_CODE_TIP4.format(['iOS 11.2 ~ 11.4.1','6.7.2']),', ',s.config.PREVIEW_QR_CODE_TIP4_SHORT.format(['Android','6.7.3']))):null,a.createElement('img',{onClick:this.onCopyClick.bind(this,'qrcode'),src:this.state.src?this.state.src:'../static/image/qrcode.png',style:{minHeight:'200px',visibility:this.state.src?'visible':'hidden'}}),a.createElement('div',{className:'previewer-loading',style:this.state.loading?{backgroundColor:'transparent'}:{display:'none'}},a.createElement('div',{className:'previewer-loading-content'},a.createElement('i',{className:'ui-icon-spinner'}),a.createElement('p',{className:'ui-desc'},this.state.progressDetailedText))),0<(this.state.filesIgnored||[]).length+(this.state.filesMissing||[]).length&&a.createElement('div',{className:'preview-qrcode-tips',style:this.state.loading?{backgroundColor:'transparent'}:{display:'none'}},a.createElement('p',null,a.createElement('a',{onClick:this.handleTipsClick.bind(this)},a.createElement('i',{className:'ui-icon-circle-x'}),a.createElement('span',null,' ',s.config.EXCEPTION_FOUND,(this.state.filesIgnored||[]).length+(this.state.filesMissing||[]).length),a.createElement('i',{className:'ui-icon-arrow-right-o'})))),a.createElement('div',{className:'preview-qrcode-tips'},a.createElement('p',{style:{display:this.state.qrcode_time?'':'none'}},a.createElement('span',null,this.state.qrcode_time),' ',s.config.EXPIRE_AT_SOME_TIME))))),c&&!d&&a.createElement('div',null,this.props.autoUploadFailureText&&a.createElement('div',null,a.createElement('p',null,s.config.PREVIEW_QR_CODE_ERR),a.createElement('pre',{style:{margin:'10px',textAlign:'left',fontSize:'12px',overflow:'auto'}},this.props.autoUploadFailureText)),!this.props.autoUploadFailureText&&a.createElement('div',{className:'previewer-qrcode'},a.createElement('div',{className:'preview-demo-img'},a.createElement('img',{src:b.headUrl,className:'preview-user-avatar'})),a.createElement('div',{className:'preview-qrcode-tips'},a.createElement('p',null,s.config.PREVIEW_QR_CODE_TIP1.format(b.nickName)),a.createElement('p',null,s.config.PREVIEW_QR_CODE_TIP2),a.createElement('p',null,s.config.PREVIEW_QR_CODE_TIP3)))),a.createElement('p',null,(()=>{const c=this.state.remoteDebugStatus;if(!b.remoteDebug)return null;if('number'!=typeof c)return null;return-1===c?a.createElement('span',{style:{color:'red',fontWeight:'600'}},s.config.REMOTE_DEBUG_END):0===c?a.createElement('span',{style:{color:'red',fontWeight:'600'}},s.config.REMOTE_DEBUG_NOT_UNINITIALIZED):1===c?a.createElement('span',{style:{color:'red',fontWeight:'600'}},s.config.REMOTE_DEBUG_NOT_CONNECTED):2===c?a.createElement('span',{style:{color:'red',fontWeight:'600'}},s.config.REMOTE_DEBUG_LOGOUT):3===c?a.createElement('span',{style:{fontWeight:'600'}},s.config.REMOTE_DEBUG_LOGINING):4===c?s.config.REMOTE_DEBUG_WAIT_SERVICE:5===c?a.createElement('span',{style:{fontWeight:'600'}},s.config.REMOTE_DEBUG_SERVER_BLOCKING):6===c?s.config.REMOTE_DEBUG_WAITING_FOR_RESPONSE:7===c?s.config.REMOTE_DEBUG_WORK_CORRECTLY:a.createElement('span',{style:{color:'red',fontWeight:'600'}},s.config.REMOTE_DEBUG_UNKNOWN)})()),(this.state.remoteDebugEvents||[]).map((b,c)=>a.createElement('p',{key:c,style:{color:'gray',fontSize:'11px'}},b.type+', '+(b.message||''))),c&&!b.remoteDebug?a.createElement('div',{className:'preview-footer'},'uploading'===b.autoUploadStatus?a.createElement('i',{className:'ui-icon-spinner'}):a.createElement('button',{onClick:this.handleTriggerAutoPreviewClick.bind(this),alt:b.displayShortcuts,title:b.displayShortcuts,className:'ui-button ui-button-default'},s.config.COMPILE_AND_PREVIEW),a.createElement('div',{className:'preview-qrcode-tips'},a.createElement('p',null,s.config.PREVIEW_QR_CODE_TIP_SHORTCUT.format(b.displayShortcuts||s.config.NONE)))):a.createElement('div',{className:'preview-footer',style:this.state.previewToolShown?{display:'none'}:{}},!this.state.stage&&!b.remoteDebug&&a.createElement('div',null,a.createElement('button',{onClick:this.onCopyClick.bind(this,'qrcode'),className:'ui-button ui-button-default'},s.config.COPY_QR_CODE))))),this.state.tipsShow&&a.createElement('div',{onClick:this.onHandleClick.bind(this),className:'ui-popover',style:{left:'262'}},a.createElement('div',{className:'previewer'},a.createElement('div',{className:'previewer-header'},a.createElement('h4',null,s.config.EXCEPTION_INFORMATION,a.createElement('i',{className:'ui-icon-ask',style:{cursor:'pointer'},title:s.config.CLICK_FOR_DETAIL,onClick:this.handleWarningAskClick.bind(this)}))),a.createElement('div',{className:'previewer-body'},a.createElement('div',{className:'previewer-msg-area'},0<(this.state.filesMissing||[]).length&&a.createElement('div',{className:'previewer-msg-group'},a.createElement('h5',null,s.config.PREVIEW_MSG_FILE_IGNORED),a.createElement('p',{style:{color:'gray'}},s.config.PREVIEW_MSG_NOT_UPLOAD_FILES),a.createElement('ul',null,(this.state.filesMissing||[]).slice(0,100).map((b,c)=>a.createElement('p',{key:c},'\xB7 '+b)),100<(this.state.filesMissing||[]).length?a.createElement('p',null,'(',(this.state.filesMissing||[]).length-100,' items not shown)'):null)),0<(this.state.filesIgnored||[]).length&&a.createElement('div',{className:'previewer-msg-group'},a.createElement('h5',null,s.config.PREVIEW_MSG_BIG_FILE),a.createElement('p',{style:{color:'gray'}},s.config.PREVIEW_MSG_BIG_FILE_DETAILS,a.createElement('a',{style:{color:'#586c94'},onClick:this.handleTipsLinkClick.bind(this)},s.config.CLICK_FOR_DETAIL)),a.createElement('ul',null,(this.state.filesIgnored||[]).slice(0,100).map((b,c)=>a.createElement('p',{key:c},'\xB7 '+b)),100<(this.state.filesIgnored||[]).length?a.createElement('p',null,'(',(this.state.filesIgnored||[]).length-100,' items not shown)'):null))))))),a.createElement('div',{className:'preview-item'},a.createElement('div',{className:'ui-popover',style:{position:'relative',width:'262',display:c||b.remoteDebug?'none':''},onClick:this.onHandleClick.bind(this)},a.createElement('div',{className:'previewer'},a.createElement('div',{className:'previewer-header',onClick:this.showPreviewTool.bind(this),style:{cursor:'pointer'}},a.createElement('h4',null,s.config.MINI_PROGRAM_DEV_ASSISTANT,a.createElement('i',{className:'ui-icon-ask',style:{cursor:'pointer'},title:s.config.CLICK_FOR_DETAIL,onClick:this.handleIconAskClick.bind(this)}))),a.createElement('div',{ref:(a)=>this.previewImgDom=a,style:this.state.previewToolShown?{}:{display:'none'}},a.createElement('div',{className:'previewer-body'},a.createElement('div',{className:'previewer-qrcode'},a.createElement('img',{onClick:this.onCopyClick.bind(this,'preview'),src:'../static/image/my-dev-apps.jpg',alt:''})))),a.createElement('div',{className:'preview-footer',style:this.state.previewToolShown?{}:{display:'none'}},a.createElement('button',{onClick:this.onCopyClick.bind(this,'preview'),className:'ui-button ui-button-default'},s.config.COPY_QR_CODE)))))))}}module.exports=u((a,b)=>{const c=(a.settings.shortcuts||{}).preview,d=p.getDisplayTextFromShortcut(c),f=a.project.current||{},g=f.runtimeAttr||{},h=g.authQY;return{show:e.PREVIEWCODE===a.toolbar.clickKey||e.REMOTEDEBUGCODE===a.toolbar.clickKey,appConfig:a.simulator.appConfig||{},project:f,authQY:h,nickName:(a.user||{}).nickName||s.config.UNKNOWN_USER,headUrl:(a.user||{}).headUrl,remoteDebug:'remotedebug'===b.mode,remoteDebugWindow:a.window.remoteDebugWindow,compilerSettings:a.settings.compiler||{},displayShortcuts:d}},(a)=>({showError:k.bindActionCreators(g.showError,a),setConfirmInfo:k.bindActionCreators(g.setConfirmInfo,a),toggleClickKey:k.bindActionCreators(i.toggleClickKey,a),setPkgSize:k.bindActionCreators(j.setPkgSize,a),showSuccessTip:k.bindActionCreators(g.showSuccessTip,a),windowActions:k.bindActionCreators(m,a),consoleActions:k.bindActionCreators(h,a),updateIDESetting(){a(o.updateIDESetting.apply(this,arguments))},autoPreview:k.bindActionCreators(i.autoPreview,a)}))(v)}(require('lazyload'),require);