;!function(require, directRequire){;"use strict";const React=require("react"),{connect}=require("react-redux"),classNames=require("classnames"),tools=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),Resizable=require('./ea653f45dc25181ca4f1b108175009b7.js'),windowActions=require('./a8c87029da0fa06e986298d447ab0fe2.js'),menuActions=require('./25d0beb4120ce2acafb4e03b95444fda.js'),assdkActions=require('./dca9191eced65b3831d60c02d8d487c2.js'),devtoolsMessager=require('./9a24eb4fb7a49d4dd24531943fc3c899.js'),idepluginMessager=require('./e9e3fd38aeedddd6db73d1d015ff6952.js'),webviewPool=require('./a78e6d6a87de1708226375ca4c320d76.js'),C=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),messageCenter=require('./ff946754202ecf377034d29daac7c8d9.js'),{validType,tokenManager}=require('./dc244a5ba483ad6e0acd267d3b91b282.js'),weappConfig=require('./6242f55dbdfe53c2f07b7a51568311f2.js'),performanceUtils=require('./344232cd2199c9c3a024b4005d054672.js'),{weappLocalIdRegular,weappUsrFilePathPrefix,weappTmpFilePathPrefix,weappStoreFilePathPrefix}=weappConfig,ABOUT_BLANK="about:blank",mapStateToProps=(a)=>{const b=a.toolbar.deviceInfo,c=a.project.current,d=a.simulator.game||{},e=a.simulator.orientation&&/^landscape(Left|Right)?$/.test(a.simulator.orientation.value);return{project:c,storage:c.storage&&c.storage.cache||{},editorShow:a.window.editor&&a.window.editor.show,show:a.window.debug.show,popup:a.window.debug.popup,webview:d.webview,webviewTs:d.webview&&d.webview.ts,screenWidth:e?b.screenHeight:b.screenWidth,screenHeight:e?b.screenWidth:b.screenHeight,device:b,theme:a.settings.appearance.devtoolsTheme||"white",debugInfo:a.simulator.debugInfo}},mapDispatchToProps=(a)=>({windowActions:tools.bindActionCreators(windowActions,a),assdkActions:tools.bindActionCreators(assdkActions,a),BBS:menuActions.BBS});class GameDevtools extends React.Component{constructor(a){super(a),this.onStorageMessage=(a)=>{const{command:b,data:c}=a;"EXEC_STORAGE_SDK"===b?this.props.assdkActions.exec(c):"STORAGE_PANNEL_SHOW"===b?(this.storageMessager.ready=!0,this.props.assdkActions.exec({api:"getStorage",args:{},callbackID:-1})):"STORAGE_PANNEL_HIDE"===b&&(this.storageMessager.ready=!1)},this.onDevtoolsMessage=(a)=>{if(!("CLICK"===a.command))"Button.popup"===a.command?this.props.windowActions.setDebuggerWindow({popup:!this.props.popup}):"THEME_MODIFIED"===a.command&&this.initWebview();else if(this.devtoolsview){const a=new UIEvent("click",{bubbles:!0});this.devtoolsview._webview.dispatchEvent(a)}},this.syncDialogMap={},this.storageMessager=idepluginMessager.get("storage_game"),this.storageMessager.register(this.onStorageMessage),devtoolsMessager.register(this.onDevtoolsMessage)}componentDidMount(){this.storageMessager.ready=!1,this.initWebview()}componentWillUnmount(){this.devtoolsview&&this.devtoolsview.detach(),devtoolsMessager.unRegister(this.onDevtoolsMessage),this.storageMessager&&this.storageMessager.unRegister(this.onStorageMessage)}componentWillReceiveProps(a){if(a.webview&&(a.webview!==this.props.webview||a.webviewTs!==this.props.webviewTs)&&(clearTimeout(this.restartTimer),this.restartTimer=setTimeout(()=>{this.initWebview()})),a.screenWidth!==this.props.screenWidth||a.screenHeight!==this.props.screenHeight){const b=a.device;devtoolsMessager.send({command:"SET_DEVICE",data:{width:a.screenWidth,height:a.screenHeight,deviceScaleFactor:parseFloat(b.dpr),mobile:!0,fitWindow:!1}})}a.storage!==this.props.storage&&this.storageMessager.triggerOnEvent("UPDATE_STORAGE",a.storage),a.theme!==this.props.theme&&this.setDevtoolsTheme(),a.debugInfo!==this.props.debugInfo&&a.debugInfo&&devtoolsMessager.send({command:"DISPATCH_MESSAGE",data:a.debugInfo})}setDevtoolsTheme(){setTimeout(()=>{const a="dark"===this.props.theme?"dark":"default";devtoolsMessager.send({command:"SET_THEME",data:a})})}initWebview(){const a=this.props;let b=this.devtoolsview;b&&b.detach(),b=webviewPool.get("devtools",{width:a.screenWidth,height:a.screenHeight,dpr:a.device.dpr}),this.devtoolsview=b;const c=tokenManager.getSessionToken(validType.UA_TOKEN),d=`${b.originUserAgent} gameservicedevtools port/${global.messageCenterPort} proxy/${global.proxyPort} token/${c} ${this.props.popup?"popup":""} ${global.isSimple?"simple":""}`;b.setUserAgentOverride(d),b.setAttribute("style","height:100%;width:100%;position:relative;display:block"),b.attach(this.container),a.webview&&this.showDevTools(a.webview)}showDevTools(a){const b=this.devtoolsview;if(!b||!a)return;b.offAll(),this.initEvent(b);const c=()=>{b.off("contentload",c),devtoolsMessager.ready=!0;const a=this.props.device;devtoolsMessager.send({command:"SET_DEVICE",data:{width:this.props.screenWidth,height:this.props.screenHeight,deviceScaleFactor:parseFloat(a.dpr),mobile:!0,fitWindow:!1}})};b.on("contentload",c);const d=()=>{(()=>{b.off("loadcommit",d),a.attached&&a.showDevTools(!0,b._webview)})()};b.on("loadcommit",d),b.src=ABOUT_BLANK}initEvent(a){a.on("exit",(a)=>{("abnormal"===a.reason||"crash"===a.reason||"killed"===a.reason)&&(this.devtoolsview&&this.devtoolsview.detach(),this.devtoolsview=void 0,setTimeout(()=>{this.initWebview()}))}),a.on("dialog",(a)=>{a.preventDefault();const b=a.messageType,c=a.messageText,d=a.dialog;if("prompt"===b){if(c===C.GET_MESSAGE_TOKEN)return void d.ok(messageCenter.getToken(["APPSERVICEDEVTOOLS","PLUGIN"]));"GET_THEME"===c?d.ok("dark"===this.props.theme?"dark":"default"):d.ok("")}else"alert"===b&&(d&&d.ok(),"FMP"===c&&performanceUtils.markDevtoolsPaint())}),a.on("newwindow",(a)=>{a.preventDefault();let b=a.targetUrl;if(b)return 0===b.indexOf(`http://127.0.0.1:${global.proxyPort}/game/gamePage.html`)||`http://127.0.0.1:${global.proxyPort}/favicon.ico`===b?void 0:0!==b.indexOf("ws://")&&0!==b.indexOf("wss://")?weappLocalIdRegular.test(b)||0===b.indexOf("http://"+weappTmpFilePathPrefix+"/")||0===b.indexOf("http://"+weappStoreFilePathPrefix+"/")||0===b.indexOf("http://"+weappUsrFilePathPrefix+"/")||0===b.indexOf("/"+weappTmpFilePathPrefix+"/")||0===b.indexOf("/"+weappStoreFilePathPrefix+"/")||0===b.indexOf("/"+weappUsrFilePathPrefix+"/")?void nw.Window.open(b,{width:799,height:799},function(){}):0===b.indexOf("https://developers.weixin.qq.com")?0===b.indexOf("https://developers.weixin.qq.com/minigame")||0===b.indexOf("https://developers.weixin.qq.com/miniprogram")?void nw.Shell.openExternal(b):void this.props.BBS(b,C.IDE_SCENE.DEBUGGER):("https://developers.google.com/web/tools/chrome-devtools/"===b&&(b="https://developers.weixin.qq.com/miniprogram/dev/index.html"),"https://developers.google.com/web/updates/2017/05/devtools-release-notes"===b&&(b="https://developers.weixin.qq.com/miniprogram/dev/devtools/uplog.html"),"chrome://inspect/"===b?void nw.Window.open(b,{width:799,height:799},function(){}):void nw.Shell.openExternal(b)):void 0})}onResizeStop(a,b,c){this.props.windowActions.setDebuggerWindow({height:c})}render(){const a=this.props,b={height:a.height};return a.show&&!a.editorShow&&(b.flex="1"),React.createElement(Resizable,{innerRef:(a)=>this.container=a,width:"100%",height:a.height,className:classNames("devtools",{"ui-invisible":!a.show}),style:b,topResizable:!0,onResizeStop:this.onResizeStop.bind(this)},React.createElement("div",{className:"ui-divider ui-divider-horizontal",style:{pointerEvents:"none"}}),React.createElement("div",{style:{width:0,height:0}}))}}module.exports=connect(mapStateToProps,mapDispatchToProps)(GameDevtools);
;}(require("lazyload"), require);
