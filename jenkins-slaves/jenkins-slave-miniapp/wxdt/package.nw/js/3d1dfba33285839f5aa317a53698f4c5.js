'use strict';!function(require,directRequire){async function a(a){return new Promise(async(b,c)=>{try{const c=await j({taskName:'processJS',config:{projectPath:a.projectPath,file:a.file,es6:a.es6?'yes':'no',minified:a.minified?'yes':'no',sourceMaps:'map',uglifyFileName:a.uglifyFileName?'yes':'no',sourceFileName:a.file,nameMapping:JSON.stringify(a.nameMapping)},dataStr:a.code,maxTimeout:180000,useBackup:!0,downgrade:!1,onAfterRun:a.onAfterRun,forceBackup:p,showInStatus:{text:`compiling ${a.file}`}});b(c)}catch(a){a instanceof Error?c(a):c(new Error(a))}})}async function b(b,f={}){return new Promise(async(h,i)=>{w[b.hash||'']||(w[b.hash||'']={});const j=w[b.hash||''],{es6:m,minified:n,uglifyFileName:o}=b.setting,{srcFilePath:p,fileBuffer:t,destFilePath:u,destPath:v,fileName:x,onAfterRun:y,projectPath:z,filesIgnored:A,nameMapping:B}=f,C=o&&B&&0<Object.keys(B).length;let D=r(t),E='';if(void 0===D){const a=new Error(g.config.FILE_NOT_UTF8.format(p));return a.code=s,i(a)}const F=Date.now(),G=l.generateMD5(D),H=`${p}_${m}_${n}_${o}`;if(j[H]&&j[H].md5===G)(m||n)&&D.length>=q&&(A||[]).push(x),D=j[H].jsCode,E=j[H].map,console.log('compile js',x,'in cache, skip.');else{if((m||n||C)&&D.length<q){const b=await a({projectPath:z,file:x,es6:m,minified:n,sourceFileName:x,code:D,onAfterRun:y,uglifyFileName:o,nameMapping:B});if(console.log(`process ${x} cost time: ${Date.now()-F}`),b.error){const a=b.error,c=new Error(a.message||a);return c.code=a.code,i(c)}D=b.code,E=b.map}else(m||n||C)&&512000<=D.length&&(A||[]).push(x),E=await k(d.join(z,x),D);try{'string'==typeof E&&(E=JSON.parse(E)),E=await k.insertSourcesContent(E,d.join(z,x)),E=JSON.stringify(E)}catch(a){E=null}j[H]={md5:G,jsCode:D,map:E}}const I=C&&B[x]?B[x]:x,J=d.join(v,I),K=d.dirname(J);e.sync(K),E&&c.writeFileSync(d.join(v,`${I}.map`),E),c.writeFileSync(J,D),h()})}const c=require('fs'),d=require('path'),e=require('mkdir-p'),f=require('./162bf2ee28b76d3b3d95b685cede4146.js'),g=require('./common/locales/index.js'),h=require('./9fdd4ac31a05c27355910f0d74accd4c.js'),i=require('./a63026ab5a5a3c59a61a9749a18aa2ca.js'),j=require('./41168dca39589e852da6631126d0f94d.js'),k=require('./cdbf7243dc99f8461acbb1d57af1d8ae.js'),l=require('./84b183688a46c9e2626d3e6f83365e13.js'),m=require('./1dea83a77e99a7c94f6b6f01f5c175b0.js'),{uglifyFileNames:n}=require('./890791d99e6d0eadf6a5a73d8d797338.js'),o=require('./1c8a8c710417d102ab574145dc51b4b0.js'),p=!1,q=512000,{bufToUTF8:r}=require('./efc820e1b92d6e4063535296d4a24213.js'),{FILE_NOT_UTF8:s,BABEL_TRANS_JS_ERR:t,UGLIFY_JS_ERR:u,BABILI_JS_ERR:v}=require('./949d8235c744ced2a80121e4dba34c28.js'),w={};module.exports=async function(a,c={}){const e=a.compileType,{distPath:j,onProgressUpdate:k,onFilesIgnored:l}=c;let p=await f(a);const q=(a.packOptions||{}).ignore||[];let r=p.getAllJSFiles().filter((a)=>!o.isFileIgnored(a,q)),s={};if(a.setting.uglifyFileName){let b=[{type:'file',value:'app.js'},{type:'regex',value:/\/miniprogram_npm\/|^miniprogram_npm\//}];const c=p.getAllWXMLFiles();for(const a of c)b.push({type:'file',value:`${a.replace(/\.wxml$/,'.js')}`});const d=await m(a);let e=[];d.subPackages&&(e=d.subPackages.map((a)=>{return a.root})),d.widgets&&0<d.widgets.length&&d.widgets.forEach((a)=>{b.push({type:'folder',value:/\/$/.test(a.path)?a.path:`${a.path}/`})}),s=await n(r,b,e)}let t=e==h.plugin?a.miniprogramRoot:'';const u=[],v=[];let w=[...r],x=(a)=>{const b=w.findIndex((b)=>b===a);0<=b&&w.splice(b,1),w[0]&&k('compilejs',g.config.PROCESSING.format(w[0]))};for(let e=0,f=r.length;e<f;e++){const c=r[e],f=p.getFile(c,null);v.push(b(a,{projectPath:p.srcPath,srcFilePath:d.join(t,c),destFilePath:d.join(j,t,c),destPath:d.join(j,t),fileBuffer:f,fileName:c,onAfterRun:x.bind(null,c),filesIgnored:u,nameMapping:s}))}const y=Date.now();if(await Promise.all(v),e==h.plugin){p=await i(a),r=p.getAllJSFiles(),t=a.pluginRoot;const c=[];w=[...r],x=(a)=>{const b=w.findIndex((b)=>b===a);0<=b&&w.splice(b,1),w[0]&&k('compilejs',g.config.PROCESSING.format(w[0]))};for(let e=0,f=r.length;e<f;e++){const f=r[e],g=p.getFile(f,null);c.push(b(a,{projectPath:p.srcPath,srcFilePath:d.join(t,f),destFilePath:d.join(j,t,f),destPath:d.join(j,t),fileBuffer:g,fileName:f,onAfterRun:x.bind(null,f),filesIgnored:u}))}await Promise.all(c)}console.log('compile all js cost time',Date.now()-y),l(u)}}(require('lazyload'),require);