'use strict';!function(require,directRequire){function a(b){if(o){const c=q.get(b);if(c){if(c.heartbeatPendingCount>t)return d.info(`unresponsive client window (id: ${b}) will be disconnected`),w(b),v({id:b,projectid:c.projectid,fromAction:!0}),q.delete(b),void p.delete(b);c.heartbeatPendingCount++,c.timeoutId=setTimeout(a.bind(this,b),s),o.postMessage({type:e.EVENT_HEARTBEAT,id:b})}}}function b(b){const{data:c}=b;switch(c.type){case e.EVENT_HEARTBEAT:{if(c.id){const a=q.get(c.id);a&&a.heartbeatPendingCount--}break}case e.EVENT_DEV_WINDOW_OPENED:{c.id&&(q.set(c.id,{[e.INIT_TIME]:+new Date,id:c.id,projectid:c.projectid,heartbeatPendingCount:0}),p.delete(c.projectid),x(),a(c.id)),r.emit(e.EVENT_DEV_WINDOW_OPENED,c.id),r.emit(`${e.EVENT_DEV_WINDOW_OPENED}-${c.id}`,c.id),r.emit(`${e.EVENT_DEV_WINDOW_OPENED}-${c.projectid}`,c.projectid);break}case e.EVENT_DEV_WINDOW_CLOSE:{v(c);break}case e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE:{q.has(c.id)?c[e.CLI_PORT]?(q.get(c.id)[e.CLI_PORT]=c[e.CLI_PORT],r.emit(e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE,c.id,c.projectid,c[e.CLI_PORT]),r.emit(`${e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE}-${c.id}`,c.id,c.projectid,c[e.CLI_PORT]),r.emit(`${e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE}-${c.projectid}`,c.id,c.projectid,c[e.CLI_PORT])):d.info(`server.sync.js: a dev window notify the update of cli port without an cliPort argument, id: ${c.id}`):d.info(`server.sync.js: a dev window, whose id is not present in client window map, notify the update of cli port: ${c.id}`);break}case e.CHANGE_LOCALE:{n.getSourceLocale()!==c.locale&&n.setLocale(c.locale);break}}}const c=require('events'),d=require('./72653d4b93cdd7443296229431a7aa9a.js'),e=require('./09060286633d09fb81fefc8ff1294dd7.js'),f=require('./84b183688a46c9e2626d3e6f83365e13.js'),g=require('./bc78839ccca8df9e5ceeb7fae11b7be2.js'),h=require('./cc2c2970ff81ae4a83123e81ee123da2.js'),i=require('./a8c87029da0fa06e986298d447ab0fe2.js'),j=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),k=require('./205e69607c4b60711b15f5ac95b40ce4.js'),l=require('./5451dfc4d939398d913dc724d952b02b.js'),m='darwin'===process.platform,n=require('./common/locales/index.js');let o;const p=new Set,q=new Map,r=new c,s=6000,t=10,u=()=>{global.Win.show(),m&&l.init(global.Win)},v=(a)=>{q.has(a.id)?(a.id===k.getCurrentBrowsingContext()&&k.setCurrentBrowsingContext(k.getMainWindowHandle()),q.delete(a.id),d.info(`dev window with id ${a.id} closed, cur ctx: ${k.getCurrentBrowsingContext()}`)):d.info(`server.sync.js: a dev window whose id is not present in client window map is closed: ${a.id}`),r.emit(e.EVENT_DEV_WINDOW_CLOSE,a.id),0===q.size&&(m?a.fromAction?(g.dispatch(i.setMainWindow(j.MAIN_WINDOW_TYPE.ENTRANCE)),u()):(u(),global.Win.hide()):a.fromAction?(g.dispatch(i.setMainWindow(j.MAIN_WINDOW_TYPE.ENTRANCE)),u()):global.contentDocument.hidden&&(0===p.size?f.quit():setTimeout(()=>{0===q.size&&global.contentDocument.hidden&&f.quit()},5e3)))},w=(a)=>{return!!o&&(o.postMessage({type:e.COMMAND_DEV_WINDOW_CLOSE,id:a}),!0)},x=()=>{o&&o.postMessage({type:e.EVENT_SVR_WINDOW_CLI_PORT_UPDATE,cliPort:global.cliPort})};module.exports={init:()=>{o=new BroadcastChannel(e.BROADCAST_CHANNEL_NAME),o.onmessage=b,r.on(e.EVENT_DEV_WINDOW_OPENED,()=>{global.Win.hide()})},once:(a)=>new Promise((b)=>{r.once(a,b)}),onceWindowOpen:({id:a,projectid:b}={})=>new Promise((c)=>{a||(a=b),r.once(`${e.EVENT_DEV_WINDOW_OPENED}-${a}`,c)}),onceCliPortUpdate:({id:a,projectid:b}={})=>new Promise((c)=>{a||(a=b),r.once(`${e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE}-${a}`,(a,b,d)=>{c(d)})}),pendingOpenWindows:p,clientWindows:q,serverSyncEvents:r,closeDevWindow:w,closeAllDevWindows:()=>{return!!o&&(o.postMessage({type:e.COMMAND_DEV_WINDOW_CLOSE_ALL}),!0)},notifyCliPortUpdate:x,getClientIdByProjectId:function(a){for(const[b,c]of q)if(c&&c.projectid===a)return b;return null},notifyChangeLocale:(a)=>{o&&o.postMessage({type:e.CHANGE_LOCALE,locale:a})}}}(require('lazyload'),require);