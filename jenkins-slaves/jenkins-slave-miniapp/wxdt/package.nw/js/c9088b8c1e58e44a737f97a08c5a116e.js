'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){const a=require('path'),b=require('react'),c=require('react-dom'),d=require('./cf139c99bcbda6ce0fa4054b089e2335.js'),e=require('./common/locales/index.js'),{model:f}=require('./63f52c9055d92f52ca0510da7d3dcadb.js'),g=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),h=require('./ff946754202ecf377034d29daac7c8d9.js'),{validType:i,tokenManager:j}=require('./dc244a5ba483ad6e0acd267d3b91b282.js'),{safeFormatSize:k,titleForEvent:l}=require('./96268d17c4410f0083b6c98f5e34acff.js'),m=(global.appConfig||{}).isDev;module.exports=class extends b.Component{constructor(){super(),this.state={events:[],askingForRetry:!1,retryCount:0,plain:'',inspectMode:!1}}onAskForRetry(a){return new Promise((b)=>{this._askingForRetryResolver=b,this.setState({askingForRetry:!0,retryCount:a})})}handleAskingForRetryResult(a){this.setState({askingForRetry:!1}),this._askingForRetryResolver&&(this._askingForRetryResolver(!!a),this._askingForRetryResolver=null)}handleUsingLocalStorageCheckboxChange(){const a=!this.props.remote.usingLocalStorage;!!a!==!!this.props.remote.usingLocalStorage&&this.props.changeUsingLocalStorage&&(this.props.changeUsingLocalStorage(a),this.setState({settingsTipsShow:!0}))}handleDisableUrlCheckCheckboxChange(){const a=!this.props.remote.disableUrlCheck;!!a!==!!this.props.remote.disableUrlCheck&&this.props.changeDisableUrlCheck&&(this.props.changeDisableUrlCheck(a),this.setState({settingsTipsShow:!0}))}handleNoMapsCheckboxChange(){const a=!this.props.remote.noMaps;!!a!==!!this.props.remote.noMaps&&this.props.changeNoMaps&&(this.props.changeNoMaps(a),this.setState({settingsTipsShow:!0}))}componentDidMount(){f.subscribeChange((a)=>{this.onStatusChange(a)}),f.subscribeEvent((a,b)=>{if(!a){if('jscontextchange'===b){const a=this.webview,b=this.props.project.compileType,c=j.getSessionToken(i.UA_TOKEN),d=this._oldUa||a.getUserAgent(),e=`${d} remotedebugdevtools ${this.props.remote.usingLocalStorage?'usinglocalstorage':''} port/${global.messageCenterPort} proxy/${global.proxyPort} token/${c} compileType/${b}`;a.setUserAgentOverride(e),this.webview.reload()}return}a=a||{};const c=[{event:{kind:a.kind,type:l(a),message:a.message},timestamp:new Date},...this.state.events];this.setState({events:c})}),f.onAskForRetry(this.onAskForRetry.bind(this)),f.onOpenEditorFile(this.openEditorFile.bind(this)),this.onStatusChange();const a=c.findDOMNode(this.container);if(!a)return;let b,d;b=this.webview=document.createElement('webview'),b.setAttribute('partition','persist:devtools'),b.src='about:blank',a.appendChild(b);const k=()=>{b.removeEventListener('loadcommit',k),b.addEventListener('dialog',(a)=>{const b=a.messageType,c=a.messageText,d=a.dialog;if('alert'!==b)'prompt'===b&&(c===g.GET_MESSAGE_TOKEN?(d.ok(h.getToken(['REMOTEDEBUGDEVTOOLS','PLUGIN'])),a.preventDefault()):'GET_THEME'===c?(d.ok('dark'===this.props.theme?'dark':'default'),a.preventDefault()):(d.ok(''),a.preventDefault()));else if(d&&d.ok(),0<=c.indexOf('debugger:paused'))f.changeDebuggerStatus(1),a.preventDefault();else if(0<=c.indexOf('debugger:resumed'))f.changeDebuggerStatus(0),a.preventDefault();else if(0<=c.indexOf('opennewtab:')){const b=c.replace('opennewtab:','');this.handleNewWindow(b),a.preventDefault()}})},m=()=>{d.removeEventListener('loadcommit',m),d.showDevTools(!0,b);const a=this.props.project.compileType,c=j.getSessionToken(i.UA_TOKEN),e=this._oldUa||b.getUserAgent(),f=`${e} remotedebugdevtools ${this.props.remote.usingLocalStorage?'usinglocalstorage':''} port/${global.messageCenterPort} proxy/${global.proxyPort} token/${c} compileType/${a}`;b.setUserAgentOverride(f),b.src=`${this.props.remote.inspectUrl}`,b.setAttribute('style','position: relative; width: 100%; height: 100%; margin: 0 auto;'),b.addEventListener('loadcommit',k),d.parentNode.removeChild(d)},n=()=>{b.removeEventListener('loadcommit',n),d=document.createElement('webview'),d.style.visibility='hidden',d.src='about:blank',a.parentNode.insertBefore(d,a),d.addEventListener('loadcommit',m)};b.addEventListener('loadcommit',n),this._cancalLocaleListener=e.onChangeLocale(()=>this.forceUpdate())}componentWillUnmount(){this._cancalLocaleListener()}async openEditorFile(b){const c=this.props.project,d=c.miniprogramRoot?a.posix.join(c.projectpath,c.miniprogramRoot):c.projectpath,e=a.posix.relative(c.projectpath,a.posix.join(d,b.file));this.props.openEditorFile&&this.props.openEditorFile({file:`/${e}`,line:parseInt(b.line)})}onStatusChange(a){let b=f.getStatus();if((!b||a)&&(b={messager:{status:-1}}),this.setState(_extends({},this.state,b)),this.webview)if(b.currentSyncSdkName){const a=b.currentSyncSdkName;this.webview.executeScript({code:`(function() { try {
            var line = document.querySelector("#console-prompt .CodeMirror-lines[role='presentation']");
            line.setAttribute("data-sdkname", "${a}")
            line.classList.add("__sync");
          } catch(e) { } })();`})}else a?this.webview.src='html/debugger-end.html':this.webview.executeScript({code:`(function() { try {
            var line = document.querySelector("#console-prompt .CodeMirror-lines[role='presentation']");
            line.setAttribute("data-sdkname", "")
            line.classList.remove("__sync");
          } catch(e) { } })();`})}handleTmpClick(){nw.Shell.openItem(this.state.dirs.tempDir)}handleDirClick(){nw.Shell.openItem(this.state.dirs.dir)}handleFinishClick(){f.endDebug()}handleOuterClick(){document.activeElement.blur()}handleErrorsClear(){this.setState({events:[]})}handleToggleSection(a){const b=[...(this.state.foldedSections||[])];b[a]=!b[a],this.setState({foldedSections:b})}handleNewWindow(a){0===a.indexOf(`http://127.0.0.1:${global.proxyPort}/appservice/appservice`)||`http://127.0.0.1:${global.proxyPort}/favicon.ico`===a||0===a.indexOf('ws://')||0===a.indexOf('wss://')||a&&('https://developers.google.com/web/tools/chrome-devtools/'===a?a='https://developers.weixin.qq.com/miniprogram/dev/index.html':'https://developers.google.com/web/updates/2017/05/devtools-release-notes'===a&&(a='https://developers.weixin.qq.com/miniprogram/dev/devtools/uplog.html'),nw.Shell.openExternal(a))}handleInspectModeChange(){const a=!this.state.inspectMode;this.setState({inspectMode:a});const b=f.getInstance();a?(d.send({command:'SHOW_PANNEL',data:{name:'Wxml'}}),b&&b.setInspectMode('searchForNode')):b&&b.setInspectMode('none')}handleJsContextIdClick(a){f.useJsContextId(a)}render(){try{`data:image/png;base64,${this.props.remote.serverInfo.qrcode_img}`}catch(a){}const{messager:a={},_debugger:c={},dirs:d={},client:f={},syncCallIds:g={},jsContext:h={}}=this.state,i=h.jsContextIdNames||{},j=h.currentContextId,l=Object.keys(i);f.deviceInfo=f.deviceInfo||{};const n=this.state.foldedSections||[];return b.createElement('div',{onClick:this.handleOuterClick.bind(this),className:'container '+('dark'===this.props.theme?'dark':'white')},b.createElement('div',{className:'debugger',ref:(a)=>this.container=a},b.createElement('div',{id:'mask',style:{display:this.state.askingForRetry?'block':'none'}})),b.createElement('div',{className:'detail'},b.createElement('div',{className:'detail-bd'},0<l.length?b.createElement('div',{className:'section'},b.createElement('div',{className:'section-hd'},b.createElement('h3',null,'Contexts')),b.createElement('div',{className:'section-bd'},l.map((a)=>{return b.createElement('div',{title:i[a],className:'meta',onClick:this.handleJsContextIdClick.bind(this,a),style:{overflow:'hidden',"text-overflow":'ellipsis',cursor:'pointer'}},b.createElement('label',{className:'key'},a),b.createElement('p',{className:'value'},i[a]),a===j?b.createElement('div',{className:'ext'},b.createElement('i',{className:'ui-icon-circle'})):null)}))):null,b.createElement('div',{className:'section'},b.createElement('div',{className:'section-hd',onClick:this.handleToggleSection.bind(this,0)},b.createElement('h3',null,f.deviceInfo.device_name||e.config.REMOTE_DEVICE_INFORMATION)),!n[0]&&b.createElement('div',{className:'section-bd'},f.deviceInfo.device_model&&b.createElement('div',{className:'meta'},b.createElement('label',{className:'key'},e.config.MOBILE_PHONE_MODEL),b.createElement('p',{className:'value'},f.deviceInfo.device_model||'-')),f.deviceInfo.os&&b.createElement('div',{className:'meta'},b.createElement('label',{className:'key'},e.config.OPERATING_SYSTEM),b.createElement('p',{className:'value'},f.deviceInfo.os||'-')),f.deviceInfo.wechat_version&&b.createElement('div',{className:'meta'},b.createElement('label',{className:'key'},e.config.WECHAT_VERSION),b.createElement('p',{className:'value'},f.deviceInfo.wechat_version||'-')),f.deviceInfo.displayPublib||f.deviceInfo.publib?b.createElement('div',{className:'meta'},b.createElement('label',{className:'key'},e.config.BASE_LIBRARY_VERSION),b.createElement('p',{className:'value'},f.deviceInfo.displayPublib||f.deviceInfo.publib||'-')):null,b.createElement('div',{className:'meta'},b.createElement('label',{className:'key'},e.config.ROUND_TRIP_TIME),b.createElement('p',{className:'value'},(()=>{return f.networkInterval&&isFinite(f.networkInterval)?600<f.networkInterval?b.createElement('span',{style:{fontWeight:'600',color:'red'}},f.networkInterval+'ms'):f.networkInterval+'ms':'-'})())),b.createElement('div',{className:'meta'},b.createElement('label',{className:'key'},e.config.CONNECTION_MODE),b.createElement('p',{className:'value'},(()=>{const a=f.networkType;if('number'!=typeof a)return'-';return 0===a?b.createElement('span',{style:{color:'red',fontWeight:'600'}},e.config.REMOTE_DEBUG_NOT_CONNECTED):1===a?'2G':2===a?'3G':3===a?'4G':4===a?'Wi-Fi':-1===a?e.config.DATA_LINE_REMOTE_DEBUG.format('Android'):-2===a?e.config.DATA_LINE_REMOTE_DEBUG.format('iOS'):e.config.OTHER})())))),b.createElement('div',{className:'section'},b.createElement('div',{className:'section-hd',onClick:this.handleToggleSection.bind(this,1)},b.createElement('h3',null,e.config.CONNECTION_INFORMATION)),!n[1]&&b.createElement('div',{className:'section-bd'},b.createElement('div',{className:'meta '+(2>a.status?'meta-warn':'')},b.createElement('label',{className:'key'},e.config.CONNECTION_STATUS),b.createElement('p',{className:'value'},(()=>{const c=a.status;return-1===c?b.createElement('span',{style:{color:'red',fontWeight:'600'}},e.config.CONNECTION_CLOSED):0===c?b.createElement('span',{style:{fontWeight:'600'}},e.config.REMOTE_DEBUG_NOT_UNINITIALIZED):1===c?b.createElement('span',{style:{fontWeight:'600'}},e.config.REMOTE_DEBUG_NOT_CONNECTED):2===c?b.createElement('span',{style:{fontWeight:'600'}},e.config.REMOTE_DEBUG_LOGOUT):3===c?b.createElement('span',{style:{fontWeight:'600'}},e.config.REMOTE_DEBUG_LOGINING):4===c?e.config.REMOTE_DEBUG_WAIT_SERVICE:5===c?b.createElement('span',{style:{fontWeight:'600'}},e.config.REMOTE_DEBUG_SERVER_BLOCKING):6===c?e.config.REMOTE_DEBUG_WAITING_FOR_RESPONSE:7===c?e.config.NORMAL:b.createElement('span',{style:{color:'red',fontWeight:'600'}},e.config.REMOTE_DEBUG_UNKNOWN)})()),7>=a.status&&4<=a.status?b.createElement('div',{className:'ext'},b.createElement('i',{className:'ui-icon-circle'})):null),b.createElement('div',{className:'meta '+(2>a.status?'meta-warn':'')},b.createElement('label',{className:'key'},e.config.SERVICE_STATE),b.createElement('p',{className:'value'},(()=>{const c=a.status;return-1===c||0===c||1===c?b.createElement('span',{style:{fontWeight:'600'}},e.config.REMOTE_DEBUG_NOT_CONNECTED):2===c||3===c||4===c?e.config.NORMAL:5===c?b.createElement('span',{style:{fontWeight:'600'}},e.config.REMOTE_DEBUG_SERVER_BLOCKING):6===c||7===c?e.config.NORMAL:e.config.REMOTE_DEBUG_UNKNOWN})()),7>=a.status&&b.createElement('div',{className:'ext'},b.createElement('i',{className:'ui-icon-circle'}))),m&&b.createElement('div',{className:'meta'},b.createElement('label',{className:'key'},e.config.NETWORK_SEND),b.createElement('p',{className:'value'},k(a.outBytesCount))),m&&b.createElement('div',{className:'meta'},b.createElement('label',{className:'key'},e.config.RECEIVED),b.createElement('p',{className:'value'},k(a.inBytesCount))),b.createElement('div',{className:'meta'},b.createElement('label',{className:'key'},e.config.TRAFFIC),b.createElement('p',{className:'value'},k(a.inBytesCount+a.outBytesCount))),0<a.compressionSavedBytes?b.createElement('div',{className:'meta'},b.createElement('label',{className:'key'},e.config.COMPRESSION_SAVING),b.createElement('p',{className:'value'},k(a.compressionSavedBytes))):null,b.createElement('div',{className:'meta'},b.createElement('label',{className:'key'},e.config.RECEIVE_MESSAGES),b.createElement('p',{className:'value'},a.inDebugMessageCount||0)),b.createElement('div',{className:'meta'},b.createElement('label',{className:'key'},e.config.SEND_MESSAGES),b.createElement('p',{className:'value'},a.outDebugMessageCount||0)),b.createElement('div',{className:'meta'},b.createElement('label',{className:'key'},e.config.SEND_RATE),b.createElement('p',{className:'value'},(a.outDebugMessageSpeed||0)+e.config.PER_SECOND)),b.createElement('div',{className:'meta'},b.createElement('label',{className:'key'},e.config.RECEIVE_RATE),b.createElement('p',{className:'value'},(a.inDebugMessageSpeed||0)+e.config.PER_SECOND)),b.createElement('div',{className:'meta'},b.createElement('label',{className:'key'},e.config.WAIT_FOR_SENDING),b.createElement('p',{className:'value'},a.cachedDebugMessagesCount||0)),b.createElement('div',{className:'meta'},b.createElement('label',{className:'key'},e.config.UNCONFIRMED),b.createElement('p',{className:'value'},a.unconfirmedMessagesCount||0)),m&&b.createElement('div',{className:'meta'},b.createElement('label',{className:'key'},e.config.SENT_PACKAGE),b.createElement('p',{className:'value'},a.outCount||0)),m&&b.createElement('div',{className:'meta'},b.createElement('label',{className:'key'},e.config.RECEIVED_PACKAGE),b.createElement('p',{className:'value'},a.inCount||0)))),this.state.askingForRetry||0<this.state.events.length?b.createElement('div',{className:'section'},b.createElement('div',{className:'section-hd'},b.createElement('h3',null,e.config.WARNINGS_AND_ERRORS),b.createElement('div',{className:'section-hd-extra',onClick:this.handleErrorsClear.bind(this)},b.createElement('i',{className:'ui-icon-circle-x'}),b.createElement('span',null,this.state.events.length||0))),b.createElement('div',{className:'section-bd section-bd-warn'},this.state.askingForRetry?b.createElement('div',{className:'msg-area'},b.createElement('div',{className:'msg-text-area'},b.createElement('p',null,b.createElement('i',{className:'ui-icon-error'}),e.config.CONNECTION_BROKEN_RECONNECT)),b.createElement('div',{className:'msg-button-area'},b.createElement('button',{className:'ui-button ui-button-primary',onClick:this.handleAskingForRetryResult.bind(this,!0)},e.config.RECONNECT))):null,this.state.events.map((a,c)=>{return a&&a.event&&a.event.type?b.createElement('div',{className:'msg '+(a.event.kind?'error-'+a.event.kind:''),key:c},'error'===a.event.kind?b.createElement('i',{className:'ui-icon-circle-x'}):null,b.createElement('p',null,(a.timestamp||new Date).toLocaleTimeString()),b.createElement('p',null,e.config.REMOTE_DEBUG_TYPE,a.event.type),a.event.message&&b.createElement('p',null,e.config.REMOTE_DEBUG_DETAILS,a.event.message)):null}))):null,b.createElement('div',{className:'section'},b.createElement('div',{className:'section-hd',onClick:this.handleToggleSection.bind(this,3)},b.createElement('h3',null,e.config.SETTING)),!n[3]&&b.createElement('div',{className:'section-bd'},b.createElement('label',{style:{display:'game'===this.props.project.compileType?'none':''},htmlFor:'',className:'ui-checkbox',onClick:this.handleUsingLocalStorageCheckboxChange.bind(this)},b.createElement('i',{className:this.props.remote.usingLocalStorage?'ui-icon-checkbox-o':'ui-icon-checkbox'}),b.createElement('span',{className:'ui-checkbox-text'},e.config.USE_TOOL_END_STORAGE)),b.createElement('label',{htmlFor:'',className:'ui-checkbox',style:{margin:'10px 0'},onClick:this.handleDisableUrlCheckCheckboxChange.bind(this)},b.createElement('i',{className:this.props.remote.disableUrlCheck?'ui-icon-checkbox-o':'ui-icon-checkbox'}),b.createElement('span',{className:'ui-checkbox-text'},e.config.NOT_VERIFY_VALIDITY)),b.createElement('label',{htmlFor:'',className:'ui-checkbox',style:{margin:'10px 0',display:'game'===this.props.project.compileType?'':'none'},onClick:this.handleNoMapsCheckboxChange.bind(this)},b.createElement('i',{className:this.props.remote.noMaps?'ui-icon-checkbox-o':'ui-icon-checkbox'}),b.createElement('span',{className:'ui-checkbox-text'},e.config.DO_NOT_INCLUDE_SOURCEMAPS||'\u4E0D\u4F7F\u7528 Source Map')),this.state.settingsTipsShow&&b.createElement('p',{className:'option',style:{color:'#999',fontSize:'12px',marginLeft:'25px',marginBottom:'25px'}},e.config.TAKE_EFFECTS_NEXT_DEBUGGING),122<=f.deviceInfo.publib&&b.createElement('label',{htmlFor:'',className:'ui-checkbox',onClick:this.handleInspectModeChange.bind(this)},b.createElement('i',{className:this.state.inspectMode?'ui-icon-checkbox-o':'ui-icon-checkbox'}),b.createElement('span',{className:'ui-checkbox-text'},e.config.NODE_INSPECTION_MODE))))),b.createElement('div',{className:'detail-ft'},b.createElement('a',{className:'hero',onClick:this.handleFinishClick.bind(this)},e.config.STOP_DEBUGGING))))}}}(require('lazyload'),require);