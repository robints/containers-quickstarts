;!function(require, directRequire){;'use strict';const path=require('path'),fs=require('fs'),mime=require('mime-types'),actionsConfig=require('./0634ee2ebd3e560d9d4804ecc960160f.js'),projectManager=require('./3bfffbe88b3d923921f851c0697974fe.js'),imagesize=require('./libs/imagesize.js'),{enterBackground,enterForeground}=require('./a3959bb900db9f65ed2e9c5dfa6977b7.js'),fileSystem=require('./f6cbcecf6ed9f533f6a506310d8f07b6.js'),fileDialog=require('./e26ed3c0cbe316b22d6ee4595ed0940d.js');function getImageOrientation(a){function b(a){return{1:'up',2:'up-mirrored',3:'down',4:'down-mirrored',5:'left-mirrored',6:'right',7:'right-mirrored',8:'left'}[a]||'up'}const c=new Uint8Array(a).buffer,d=new DataView(c);if(65496!==d.getUint16(0,!1))return b(-2);const e=d.byteLength;try{for(let a=2;a<e;){const c=d.getUint16(a,!1);if(a+=2,65505===c){if(1165519206!==d.getUint32(a+=2,!1))return b(-1);const c=18761===d.getUint16(a+=6,!1);a+=d.getUint32(a+4,c);const e=d.getUint16(a,c);a+=2;for(let f=0;f<e;f++)if(274===d.getUint16(a+12*f,c))return b(d.getUint16(a+12*f+8,c))}else if(65280!=(65280&c))break;else a+=d.getUint16(a,!1)}}catch(a){return b(-1)}return b(-1)}function isVedio(a){const b=mime.lookup(a);return 0<=b.indexOf('video/')}async function getVideoStat(a){return new Promise((b,c)=>{const d=document.createElement('video');d.addEventListener('error',(a)=>{console.error(a);try{c(a.path[0].error.message)}catch(b){c(a)}}),d.addEventListener('loadedmetadata',()=>{d.play();let a=parseFloat(d.duration);a=isNaN(a)?0:a;const c=Math.min(100*a,500);setTimeout(()=>{const a=document.createElement('canvas');a.width=d.videoWidth,a.height=d.videoHeight,a.getContext('2d').drawImage(d,0,0,a.width,a.height);const c=a.toDataURL().replace(/^data:image\/(jpg|png);base64,/,''),e=projectManager.getCurrent(),f=fileSystem.saveBase64DataToFile(e,c,'.jpg');let g='';f.error||(g=f.tempFilePath),b({duration:d.duration,width:d.videoWidth,height:d.videoHeight,thumbTempFilePath:g})},c)}),d.setAttribute('src',a.replace(/^https?:\/\//,`$&127.0.0.1:${global.proxyPort}/`)),d.defaultMuted=!0})}async function previewImage(a,b){return a({type:actionsConfig.SIMULATOR_SET_PREVIEW_IMAGE,data:{show:!0,urls:b.args.urls||[],current:b.args.current||''}}),{errMsg:`${b.api}:ok`}}async function chooseImage(a,b){const c=b.args,d=Number.isInteger(c.count)&&9>=c.count&&1<=c.count?c.count:9;enterBackground('chooseFile');const e=await fileDialog.chooseFile({accept:'image/*',multiple:1<d});if(enterForeground('chooseFile'),e.success){const a=e.event,c=[],f=[];let g=a.target.value.split(';');g=g.slice(0,d),g.forEach((a)=>{const b=path.extname(a);try{const b=fs.lstatSync(a);f.push(b.size)}catch(a){return}const d=projectManager.getCurrent();c.push(fileSystem.copyFileToTemp(d,a,b))});const h={errMsg:`${b.api}:ok`,tempFilePaths:c};return 1002000<=projectManager.getLibVersionNumber()&&(h.tempFileSizes=f),h}return{errMsg:`${b.api}:cancel`}}async function chooseVideo(a,b){b.args;enterBackground('chooseFile');const c=await fileDialog.chooseFile({accept:'video/*'});if(enterForeground('chooseFile'),c.success){const a=c.event,d=a.target.value.split(';'),e=[],f=d[0],g=path.extname(f),h=projectManager.getCurrent();e.push(fileSystem.copyFileToTemp(h,f,g));const i=fs.statSync(f),j=await getVideoStat(e[0]);return{errMsg:`${b.api}:ok`,tempFilePath:e[0],size:i.size,duration:j.duration,width:j.width,height:j.height,thumbTempFilePath:j.thumbTempFilePath}}return{errMsg:`${b.api}:cancel`}}async function getImageInfo(a,b){const c=b.args.src;if(!c)return{errMsg:`${b.api}:fail file not found`};const d=projectManager.getCurrent(),e=fileSystem.getFileRealPath(c,d),f=e.fileRealPath;return fs.existsSync(f)?new Promise((a)=>{const c=fs.createReadStream(f);imagesize(c,function(c,d){c?a({errMsg:`${b.api}:fail ${c.toString()}`}):a({errMsg:`${b.api}:ok`,width:d.width,height:d.height,type:d.format,orientation:getImageOrientation(fs.readFileSync(f))})})}):{errMsg:`${b.api}:fail file not found`}}async function saveVideoToPhotosAlbum(a,b){const{api:c,args:d}=b,e=d.filePath,f=fileSystem.getFileRealPath(e),g=f.fileRealPath;if(f.error)return{errMsg:`${c}:fail ${f.error.reason||'file not found'}`};if(f.type!==fileSystem.TMP&&f.type!==fileSystem.STORE&&f.type!==fileSystem.USR&&f.type!==fileSystem.PACKAGE||!fs.existsSync(g))return{errMsg:`${c}:fail file not found`};const h=path.basename(g),i=await fileDialog.saveFile({name:h,accept:'video/*'});if(i.success){const a=i.event,b=a.target.value;return fs.writeFileSync(b,fs.readFileSync(g)),{errMsg:`${c}:ok`}}return{errMsg:`${c}:cancel`}}async function saveImageToPhotosAlbum(a,b){const{api:c,args:d}=b,e=d.filePath,f=fileSystem.getFileRealPath(e),g=f.fileRealPath;if(f.type===fileSystem.USR&&f.type===fileSystem.TMP&&f.type===fileSystem.STORE&&f.type===fileSystem.PACKAGE||!fs.existsSync(g)||!fs.statSync(g).isFile())return{errMsg:`${c}:fail file not found`};const h=path.basename(g),i=await fileDialog.saveFile({name:h,accept:'image/*'});if(i.success){const a=i.event,b=a.target.value;return fs.writeFileSync(b,fs.readFileSync(g)),{errMsg:`${c}:ok`}}return{errMsg:`${c}:cancel`}}async function chooseMedia(a,b){const c=b.args||{},d=b.api,e=Number.isInteger(c.count)&&9>=c.count&&1<=c.count?c.count:9,f=c.mediaType||['video','image'],g=[];let h=!1;0<=f.indexOf('video')&&g.push('video/*'),0<=f.indexOf('image')&&(h=!0,g.push('image/*')),enterBackground('chooseFile');const i=await fileDialog.chooseFile({accept:g.join(','),multiple:!!h&&1<e});if(enterForeground('chooseFile'),i.success){const a=i.event;let b=a.target.value.split(';');b=b.slice(0,e);let c='';b.forEach((a)=>{!c&&isVedio(a)&&(c=a)});const f=[],g=projectManager.getCurrent();if(c){const a=c,b=path.extname(a),e=fs.statSync(a),f=fileSystem.copyFileToTemp(g,a,b);let h;try{h=await getVideoStat(f)}catch(a){const b=a.toString&&a.toString()||`${a}`;return console.warn(b),{errMsg:`${d}:fail ${b}`}}const i=Object.assign({tempFilePath:f,size:e.size},h);return{errMsg:`${d}:ok`,type:'video',tempFiles:[i]}}return b.forEach((a)=>{const b=path.extname(a),c=fs.statSync(a);f.push({tempFilePath:fileSystem.copyFileToTemp(g,a,b),size:c.size})}),{errMsg:`${d}:ok`,type:'image',tempFiles:f}}return{errMsg:`${d}:cancel`}}async function wx_chooseFile(a,b){const c=b.args||{},d=b.api;let e=(c.type||'').toLowerCase();const f=parseInt(c.count,10)||1;0>['file','video','image'].findIndex((a)=>a===e)&&(e='file');let g='*/*';'video'===e?g='video/*':'image'===e&&(g='image/*'),enterBackground('chooseFile');const h=await fileDialog.chooseFile({accept:g,multiple:1<f});if(enterForeground('chooseFile'),h.success){const a=h.event,c=[],d=a.target.value.split(';');d.forEach((a)=>{const b={name:path.basename(a)},d=path.extname(a);try{const c=fs.lstatSync(a);b.size=c.size}catch(a){console.error(a)}const e=projectManager.getCurrent();b.path=fileSystem.copyFileToTemp(e,a,d);const f=(mime.lookup(a)||'').toLowerCase();let g='file';0<=f.indexOf('video/')?g='video':0<=f.indexOf('image/')&&(g='image'),b.type=g,c.push(b)});const e={errMsg:`${b.api}:ok`,tempFiles:c.slice(0,f)};return e}return{errMsg:`${b.api}:cancel`}}module.exports={chooseFile:wx_chooseFile,chooseVideo,chooseImage,chooseMessageFile:wx_chooseFile,previewImage,getImageInfo,chooseMedia,saveVideoToPhotosAlbum,saveImageToPhotosAlbum};
;}(require("lazyload"), require);
