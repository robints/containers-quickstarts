'use strict';!function(require,directRequire){function a(a){return a.replace(L,'').replace(M,'').replace(N,'').replace(O,'')}function b(a=12){const b='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let c='';for(let d=0;d<a;d++){const a=Math.floor(Math.random()*b.length);c+=b.substring(a,a+1)}return c}function c(){const a=y.getUserInfo(),b=a?a.openid:'unknow';return b||''}function d(a,b){const d=a.appid,e=c();if(b||!P[`${d}_${e}`]){const a=q.join(K,e,d);!b&&r.existsSync(a)&&r.existsSync(q.join(a,F))&&r.existsSync(q.join(a,G))&&r.existsSync(q.join(a,H))&&r.existsSync(q.join(a,J))||(t.sync(q.join(a,F)),t.sync(q.join(a,G)),t.sync(q.join(a,H)),t.sync(q.join(a,J))),P[`${d}_${e}`]=!0}}function e(a){return L.test(a)?F:M.test(a)?G:N.test(a)?H:O.test(a)?J:I}function f(a,d,e){const f=a.appid,g=c(),h=s.createHash('md5');return d=d||`${Date.now()}`,h.update(d),`${f}.${g}.${b()}${h.digest('hex')}${e}`}function g(a){const b=a.appid,d=c();return q.join(K,d,b)}function h(b,d){/^\/usr\/?$/i.test(b)||/^http:\/\/usr\/?$/i.test(b)?b='/usr/./':/^\/tmp\/?$/i.test(b)||/^http:\/\/tmp\/?$/i.test(b)?b='/tmp/./':/^\/store\/?$/i.test(b)||/^http:\/\/store\/?$/i.test(b)?b='/store/./':(/^\/opendata\/?$/i.test(b)||/^http:\/\/opendata\/?$/i.test(b))&&(b='/opendata/./');const f=e(b);d=d||z.getCurrent();let g;if(f!==I){b=a(b);let e,h;e=d.appid||'',h=c();let i=q.join(K,h,e,f);if(i=/(\/|\\)$/.test(i)?i:i+'/',i=q.normalize(i),g=q.join(K,h,e,f,b),!g.startsWith(i))return{error:!0}}else{const a=d.miniprogramRoot,c=q.extname(b),e={".wxml":!0,".js":!0,".wxss":!0};if(z.isGameApp()||(e['.json']=!0),!e[c]){let c;if(a?(c=q.join(d.projectpath,a),c=/(\/|\\)$/.test(c)?c:c+'/',c=q.normalize(c),g=q.join(d.projectpath,a,b)):(c=q.join(d.projectpath),c=/(\/|\\)$/.test(c)?c:c+'/',c=q.normalize(c),g=q.join(d.projectpath,b)),!g.startsWith(c))return{error:!0}}}return{error:!1,fileRealPath:g,type:f}}function i(a,b,d){const e=f(a,b,d),g=c(),h=q.join(K,g,a.appid,G,e);return r.writeFileSync(h,b),`${C}${e}`}function j(){const a=z.getCurrentRuntimeConfig(),b=a.setting.MaxFileStorageSize;return 1024*(1024*(b||10))}function k(){const a=z.getCurrentRuntimeConfig(),b=a.setting.OpendataMaxFileStorageSize;return 1024*(1024*(b||10))}function l(a,b){const d=c(),e=a.appid,g=q.join(K,d,e,b);let h=0;const i={},f=u.sync('**/**',{statCache:i,nodir:!0,stat:!0,cwd:g})||[];return f.forEach((a)=>{const b=i[q.join(g,a).replace(/\\/g,'/')];b&&(h+=b.size||0)}),h}function m(a,b,c){const d=1,e=65536;(function(a,b,c){if('string'!=typeof b)throw new Error('_dest must be a string');if('string'!=typeof a)throw new Error('_src must be a string');if('number'==typeof c&&c&&c!==d)throw Error(`EINVAL: invalid argument, copyfile -> '${b}'`)})(a,b,c);const f=c===d?'wx':'w',{size:g,mode:h}=r.statSync(a),j=r.openSync(a,'r'),k=r.openSync(b,f,h),l=g<e?g:e;let m=0;const n=g<e?0:g%e,o=0;let p=Buffer.allocUnsafe(l);for(let d=0;l+m+n<=g;d++,m=l*d)r.readSync(j,p,o,l,m),r.writeSync(k,p,o,l,m);if(n){const a=n;p=Buffer.allocUnsafe(a),r.readSync(j,p,o,a,m),r.writeSync(k,p,o,a,m)}r.closeSync(j),r.closeSync(k)}function n(a,b){return p(a,b,[F,J])}function o(a,b){return p(a,b,I)}function p(a,b,c){const d=h(b);if(!Array.isArray(c)&&d.type!==c)return{error:!0,reason:`permission denied, open ${b}`};if(Array.isArray(c)&&!c.includes(d.type))return{error:!0,reason:`permission denied, open ${b}`};const e=d.fileRealPath,f=q.dirname(e);let g=!1;try{const a=r.lstatSync(f);g=a.isDirectory()}catch(a){}return g?{error:!1,realDirPath:f,fileRealPath:e,type:d.type}:{error:!0,reason:`no such file or directory ${b}`}}const q=require('path'),r=require('fs'),s=require('crypto'),t=require('mkdir-p'),u=require('glob'),v=require('rmdir'),w=require('adm-zip'),x=require('rimraf'),y=require('./89ba85d67a88f7636d657c22b5d3e038.js'),z=require('./3bfffbe88b3d923921f851c0697974fe.js'),{DATA_PATH:A,USER_DATA_PATH:B,TMP_DATA_PATH:C,STORE_DATA_PATH:D,OPENDATA_PATH:E}=require('./37be435102276ea9cf47609ff6535cd4.js'),F='usr',G='tmp',H='store',I='package',J='opendata',{WeappFileSystem:K}=require('./92320c1386e6db6a6f2556736a9bc280.js'),L=/^(http:\/)?\/usr\//,M=/^(http:\/)?\/tmp\//,N=/^(http:\/)?\/store\//,O=/^(http:\/)?\/opendata\//,P={},Q=(a,b=!1)=>{let c;switch(a){case F:{c=h('http://usr/./').fileRealPath;break}case G:{c=h('http://tmp/./').fileRealPath;break}case H:{c=h('http://store/./').fileRealPath;break}case J:{c=h('http://opendata/./').fileRealPath;break}case I:{c=h('./').fileRealPath;break}default:return null;}return c=b&&c?/(\/|\\)$/.test(c)?c:c+'/':/(\/|\\)$/.test(c)?c.slice(0,-1):c,q.normalize(c)},R={saveStoreFile:function(a,b){const c=a.appid,d=h(b);if(d.type===G){const a=d.fileRealPath;if(r.existsSync(a)){const b=r.lstatSync(a);if(b.isSymbolicLink())return{error:!0,reason:'tempFilePath is not a regular file'};const c=q.basename(a),d=r.readFileSync(a),e=q.join(a,'..','..',H,c);r.writeFileSync(e,d);try{r.unlinkSync(a)}catch(b){console.error('unlink file',a,'failed')}return{error:!1,savedFilePath:`${D}${c}`}}}return{error:!0,reason:'tempFilePath file not exist'}},saveUsrFile:function(a,b,d){const e=a.appid,f=c(),g=h(d,a);if(g.type!==F&&g.type!==J)return{error:!0,reason:`permission denied, open "${d}"`};const i=g.fileRealPath,j=q.dirname(i);let k=!1;try{const a=r.lstatSync(j);k=a.isDirectory()}catch(a){}if(!k)return{error:!0,reason:`no such file or directory "${q.dirname(d)}"`};const l=h(b);if(!r.existsSync(l.fileRealPath))return{error:!0,reason:`no such file or directory "${b}"`};const m=r.lstatSync(l.fileRealPath);if(m.isSymbolicLink())return{error:!0,reason:'tempFilePath is not a regular file'};const n=r.readFileSync(l.fileRealPath);return r.writeFileSync(i,n),{error:!1,savedFilePath:d}},copyFileToTemp:function(a,b,c){const d=r.readFileSync(b);return i(a,d,c)},copyFileDataToTemp:i,getUsrFileList:function(a){const b=c(),d=a.appid,e=q.join(K,b,d,H),f={},g=u.sync('**/**',{statCache:f,nodir:!0,stat:!0,cwd:e});let h=0;for(const b in f)h+=f[b].size||0;return{error:!1,fileList:g,totalSize:h}},getSavedFileList:function(a){const b=c(),d=a.appid,e=q.join(K,b,d,H);let f=0;const g={},h=u.sync('**/**',{statCache:g,nodir:!0,stat:!0,cwd:e}),i=h.map((a)=>{const b=g[q.join(e,a).replace(/\\/g,'/')];return f+=b.size,{filePath:`${D}${a}`,size:b.size,createTime:parseInt(b.ctime.getTime()/1e3)}});return{error:!1,fileList:i,totalSize:f}},readFile:function(a,b,c){const d=h(b),e=d.fileRealPath;if(!r.existsSync(e))return{error:!0,reason:`${b} not found`};const f=r.lstatSync(e);if(f.isSymbolicLink())return{error:!0,reason:`${b} is not a regular file`};const g=r.readFileSync(e,c);return{error:!1,fileData:g}},writeFile:function(a,b,c,d='utf8'){const e=n(a,b);if(e.error)return e;const f=e.fileRealPath;if(r.existsSync(f)){const a=r.lstatSync(f);if(a.isSymbolicLink())return{error:!0,reason:`${b} is not a regular file`};if(a.isDirectory())return{error:!0,reason:`illegal operation on a directory, open ${b}`}}try{const b=Buffer.from(c,d),f=b.byteLength||0;if(e.type===F&&l(a,F)+l(a,H)+f>j(a)||e.type===J&&l(a,J)+f>k(a))return{error:!0,reason:'the maximum size of the file storage limit is exceeded'}}catch(a){}return r.writeFileSync(f,c,d),{error:!1}},mkdir:function(a,b){const c=n(a,b);if(c.error)return c;const d=c.fileRealPath;return r.existsSync(d)?{error:!0,reason:`file already exists ${b}`}:(t.sync(d),{error:!1})},rmdir:function(a,b,d=!1){const e=n(a,b);if(e.error)return e;const f=e.fileRealPath,g=e.realDirPath,h=c();if(g===q.join(K,h,a.appid))return{error:!0,reason:`permission denied, open ${b}`};if(!r.existsSync(f)||!r.lstatSync(f).isDirectory())return{error:!0,reason:`no such file or directory  ${b}`};if(!d){const a=r.readdirSync(f).filter(()=>!0);if(0!==a.length)return{error:!0,reason:'directory not empty'};r.rmdirSync(f)}else x.sync(f);return{error:!1}},readdir:function(a,b){const c=h(b+'/');let d;if(d=c.type===I?o(a,b+'/'):n(a,b+'/'),d.error)return d;const e=d.fileRealPath;if(!r.existsSync(e))return{error:!0,reason:`no such file or directory  ${b}`};if(!r.lstatSync(e).isDirectory())return{error:!0,reason:`not a directory  ${b}`};const f=r.readdirSync(e).filter(()=>!0);return{error:!1,files:f}},createTmpfileName:function(a,b){return`${C}${f(a,'',b)}`},initTmpfileName:function(a,b,c){return`${C}${f(a,b,c)}`},getFileSystemDir:g,unlink:function(a,b){const c=h(b,a);if(c.type===I)return{error:!0,reason:`fail permission denied, open "${b}"`};const d=c.fileRealPath;if(!r.existsSync(d))return{error:!0,reason:`fail no such file or directory "${b}"`};const e=r.lstatSync(d);if(e.isDirectory())return{error:!0,reason:`fail operation not permitted, unlink "${b}"`};try{r.unlinkSync(d)}catch(a){return{error:!0,reason:a.toString()}}return{error:!1}},stat:function(a,b){const c=h(b,a);if(c.type===I&&0===b.indexOf(A))return{error:!0,reason:`fail permission denied, open "${b}"`};const d=c.fileRealPath;if(!r.existsSync(d))return{error:!0,reason:`fail no such file or directory "${b}"`};const e=r.lstatSync(d);return{error:!1,mode:e.mode,size:e.size,lastAccessedTime:parseInt(e.atimeMs/1e3),lastModifiedTime:parseInt(e.mtimeMs/1e3)}},saveBase64DataToFile:function(a,b,d){const e=a.appid,g=c(),h=f(a,b,d);return h.includes('/')||h.includes('\\')?{error:!0,reason:`permission denied, open "${h}`}:(r.writeFileSync(q.join(K,g,e,G,h),b,{encoding:'base64'}),{error:!1,tempFilePath:`${C}${h}`})},clearFileSystem:function(a){const b=g(a);v(b,()=>{d(a,!0)})},unzip:function(a,b,c){const d=h(b),e=d.fileRealPath;if(!e||!r.existsSync(e))return{error:!0,reason:`no such file or directory, unzip "${b}"`};const f=c,g=h(c),i=g.fileRealPath;if(!i||g.type!==F&&g.type!==J)return{error:!0,reason:`permission denied, unzip "${f}"`};const m=q.dirname(i);if(!r.existsSync(m)||r.lstatSync(m).isSymbolicLink())return{error:!0,reason:`no such file or directory, unzip "${f}"`};const n=r.lstatSync(e);if(n.isSymbolicLink())return{error:!0,reason:`${b} is not a regular file`};try{const b=new w(e),c=b.getEntries();let d=0;for(const a of c){const c=a.entryName;if(/^\.\.(\\|\/)+/.test(c))throw new Error('illegal access');if(/(\\|\/)+\.\.(\\|\/)+/.test(c))throw new Error('illegal access');if(/(\\|\/)+\.\.$/.test(c))throw new Error('illegal access');const e=b.readFile(a);d+=e.byteLength}if(g.type===F&&l(a,F)+l(a,H)+d>j(a)||g.type===J&&l(a,J)+d>k(a))return{error:!0,reason:'the maximum size of the file storage limit is exceeded'};b.extractAllTo(i,!0)}catch(a){return{error:!0,reason:'unzip failed'}}return{error:!1}},rename:function(a,b,c){const d=h(b),e=d.fileRealPath;if(!e||!r.existsSync(e))return{error:!0,reason:`no such file or directory, rename "${b}"`};if(d.type===I)return{error:!0,reason:`permission denied, rename "${b}" -> "${c}"`};const f=h(c),g=f.fileRealPath;if(!g||f.type!==F&&f.type!==J)return{error:!0,reason:`permission denied, rename "${b}" -> "${c}"`};const i=Q(F,!0),j=Q(G,!0),k=Q(H,!0),l=Q(I,!0),m=Q(J,!0);if(!e.startsWith(i)&&!e.startsWith(j)&&!e.startsWith(k)&&!e.startsWith(l)&&!e.startsWith(m))return{error:!0,reason:`permission denied, rename "${b}" -> "${c}"`};if(e===i||e===j||e===k||e===l||e===m)return{error:!0,reason:`permission denied, rename "${b}" -> "${c}"`};if(g===i||g===m)return{error:!0,reason:`permission denied, rename "${b}" -> "${c}"`};if(!g.startsWith(i)&&!g.startsWith(m))return{error:!0,reason:`permission denied, rename "${b}" -> "${c}"`};if(r.lstatSync(e).isSymbolicLink())return{error:!0,reason:`${b} is not a regular file`};if(r.existsSync(g)&&r.lstatSync(g).isSymbolicLink())return{error:!0,reason:`${c} is not a regular file`};const n=q.dirname(g);if(!r.existsSync(n)||r.lstatSync(n).isSymbolicLink())return{error:!0,reason:`no such file or directory, rename "${c}"`};try{r.renameSync(e,g)}catch(a){return{error:!0,reason:'rename failed'}}return{error:!1}},copyFile:function(a,b,c){const d=h(b),e=d.fileRealPath;if(!e||!r.existsSync(e))return{error:!0,reason:`no such file or directory, copyFile "${b}"`};const f=h(c),g=f.fileRealPath;if(!g||f.type!==F&&f.type!==J)return{error:!0,reason:`permission denied, copyFile "${b}" -> "${c}"`};const i=r.lstatSync(e);if(!i.isFile())return{error:!0,reason:`permission denied, copyFile "${b}" -> "${c}"`};if(i.isSymbolicLink())return{error:!0,reason:`${b} is not a regular file`};const n=l(a,F)+l(a,H);if(f.type===F&&n+(i.size||0)>j(a)||f.type===J&&n+(i.size||0)>k(a))return{error:!0,reason:'the maximum size of the file storage limit is exceeded'};const o=Q(F,!0),p=Q(J,!0);if(p===g||o===g)return{error:!0,reason:`permission denied, copyFile "${b}" -> "${c}"`};if(!g.startsWith(o)&&!g.startsWith(p))return{error:!0,reason:`permission denied, copyFile "${b}" -> "${c}"`};if(r.existsSync(g)&&r.lstatSync(g).isSymbolicLink())return{error:!0,reason:`${c} is not a regular file`};if(g===e)return{error:!1};if(r.existsSync(g)){try{r.unlinkSync(g)}catch(a){}try{r.rmdirSync(g)}catch(a){}}const s=q.dirname(g);if(!r.existsSync(s)||r.lstatSync(s).isSymbolicLink())return{error:!0,reason:`no such file or directory, copyFile "${c}"`};try{m(e,g)}catch(a){return{error:!0,reason:'copyFile failed'}}return{error:!1}},appendFile:function(a,b,c,d){const e=h(b);if(!e||e.type!==F&&e.type!==J)return{error:!0,reason:`permission denied, open "${b}"`};const f=e.fileRealPath;if(!f||!r.existsSync(f))return{error:!0,reason:`no such file or directory, open "${b}"`};const g=r.lstatSync(f);if(!g.isFile())return{error:!0,reason:`illegal operation on a directory, open "${b}"`};if(g.isSymbolicLink())return{error:!0,reason:`${b} is not a regular file`};const i=Buffer.from(c,d||'utf-8'),m=l(a,F)+l(a,H);if(e.type===F&&m+(i.byteLength||0)>j(a)||e.type===J&&l(a,J)+(i.byteLength||0)>k(a))return{error:!0,reason:'the maximum size of the file storage limit is exceeded'};try{r.appendFileSync(f,c,d||'utf-8')}catch(a){return{error:!0,reason:a.toString&&a.toString()||a}}return{error:!1}}};Object.getOwnPropertyNames(R).forEach(function(a){const b=R[a];R[a]=function(){return d(arguments[0]),b.apply(R,arguments)}}),R.getFileRealPath=h,R.removeSavedFile=function(a){const b=h(a),c=b.fileRealPath;if(b.type===H&&r.existsSync(c)){try{r.unlinkSync(c)}catch(a){}return{error:!1}}return{error:!0,reason:'file not exist'}},R.getFileStat=function(a){const b=h(a),c=b.fileRealPath;try{const a=r.statSync(c);return{error:!1,size:a.size,createTime:parseInt(a.ctime.getTime()/1e3)}}catch(a){return{error:!0,reason:'file not found'}}},R.getFileInfo=function(a,b,c){const d=h(a);if(c&&d.type!==c)return{error:!0,reason:'file not find'};const e=d.fileRealPath;if(r.existsSync(e)){const c=r.lstatSync(e);if(c.isDirectory())return{error:!0,reason:`${a} is directory`};if(c.isSymbolicLink())return{error:!0,reason:`${a} is not a regular file`};const d=r.readFileSync(e);let f='';if('md5'===b){const a=s.createHash('md5');a.update(d),f=a.digest('hex')}else if('sha1'===b){const a=s.createHash('sha1');a.update(d),f=a.digest('hex')}return{error:!1,size:c.size,createTime:parseInt(c.ctime.getTime()/1e3),digest:f}}return{error:!0,reason:'file not exist'}},R.isLocalId=function(a){return 0===a.indexOf(B+'/')||0===a.indexOf(C)||0===a.indexOf(D)||0===a.indexOf(E)},R.USR='usr',R.TMP='tmp',R.STORE='store',R.PACKAGE='package',R.STORE_DATA_PATH=D,R.DATA_PATH=A,R.USER_DATA_PATH=B,R.TMP_DATA_PATH=C,module.exports=R}(require('lazyload'),require);