'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){async function a(a,b,c){return new Promise((d)=>{a({type:l.SIMULATOR_SET_AUTHORIZE_CONFIRM,data:{show:!0,scopeList:c.scopeList,imageUrl:c.imageUrl,appName:c.appName,callback:async(a,c)=>{a=a&&c[0].checked;const{body:e}=await g({url:`${i.jsOperateWXDATAURL}`,method:'post',body:JSON.stringify({data:JSON.stringify(b.args.data||{}),grant_scope:c[0].scope,opt:a?1:2}),needToken:1,needAppID:1});return a?d({errMsg:`${b.api}:ok`,data:JSON.parse(e.data)}):d({errMsg:`${b.api}:fail auth deny`})}}})})}async function b(a){if(!(Date.now()-q<p))return q=Date.now(),new Promise((b)=>{a({type:l.SIMULATOR_SET_CONFIRM,data:{show:!0,content:m.config.GETUSERINFO_NOT_AUTHORIZED_WINDOW,showCancel:!0,cancelText:m.config.CONTINUE_USE,confirmText:m.config.VIEW_DETAILS,callback:async(a)=>{a&&!global.autoTest&&nw.Shell.openExternal('https://developers.weixin.qq.com/blogdetail?action=get_post_info&lang=zh_CN&token=1650183953&docid=0000a26e1aca6012e896a517556c01'),b()}}})})}async function c(a,b){const{body:c}=await g({url:`${i.jsAuthorizeConfirmURL}`,method:'post',body:JSON.stringify({scope:b,opt:a?1:2}),needToken:1,needAppID:1});return c.baseresponse&&0===c.baseresponse.errcode?a?'ok':'fail auth deny':'fail request error'}async function d(a,b,d){return new Promise((e)=>{a({type:l.SIMULATOR_SET_CONFIRM,data:_extends({},d,{confirmText:m.config.ALLOW,cancelText:m.config.NOT_ALLOW,showCancel:!0,show:!0,callback:async(a)=>{const d=await c(a,['scope.userLocation']);e({errMsg:`${b.api}:${d}`})}})})})}async function e(a,b,d){return new Promise((e)=>{a({type:l.SIMULATOR_SET_AUTHORIZE_CONFIRM,data:_extends({},d,{show:!0,callback:async(a,d)=>{const f=[];d.forEach((a)=>{a.checked&&f.push(a.scope)});const g=await c(a,f);e({errMsg:`${b.api}:${g}`})}})})})}async function f(){for(;0<r.length;){const a=r[0];if(!a)break;try{const b=await a.fn();a.resolve(b)}catch(b){a.reject(b)}r.shift()}}const g=require('./15ba1827c7f6564a45df6bd44da3a977.js'),h=require('./3bfffbe88b3d923921f851c0697974fe.js'),i=require('./f171257bbcaef547a3cf27266ccb0db2.js'),j=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),k=require('./df6d0ff021a69fb541c733de4dbba0fe.js'),l=require('./0634ee2ebd3e560d9d4804ecc960160f.js'),m=require('./common/locales/index.js'),{enterBackground:n,enterForeground:o}=require('./a3959bb900db9f65ed2e9c5dfa6977b7.js'),p=1800000;let q=0,r=[];module.exports={login:async function(a,b){const{body:c}=await g({url:`${i.jsLoginURL}`,method:'post',body:JSON.stringify({scope:['snsapi_base']}),needToken:1,needAppID:1});return{errMsg:`${b.api}:ok`,code:c.code}},refreshSession:async function(a,b){const{body:c}=await g({url:`${i.jsRefreshSessionURL}`,method:'post',needToken:1,needAppID:1});return{errMsg:`${b.api}:ok`,expireIn:c.session_expire_in,err_code:c.baseresponse.errcode}},operateWXData:async function(c,d,e){const f=h.getCurrent(),m=e(),{args:n,api:o}=d;if('webapi_getuserinfo'==n.data.api_name&&(1003000>h.getLibVersionNumber()&&(delete n.data.lang,delete n.data.with_credentials),f.isTourist)){const a=m.user||{};return{errMsg:'operateWXData:ok',data:{data:JSON.stringify({nickName:a.nickName,avatarUrl:a.headUrl,gender:'male'===a.sex?1:2,province:a.province,city:a.city,country:a.country})}}}const{body:p}=await g({url:`${i.jsOperateWXDATAURL}`,method:'post',body:JSON.stringify({data:JSON.stringify(n.data||{})}),needToken:1,needAppID:1,needCheckErrCode:-1}),q=p.baseresponse;if(q){const e=p.baseresponse.errcode;if(0==e){const a=JSON.parse(p.data);try{const b=n.data&&n.data.api_name&&n.data.api_name.replace('webapi_','')||b;c({type:l.SIMULATOR_UPDATE_DECRYPTED_INFO,api:b,data:{encryptedData:a.encryptedData,iv:a.iv,sessionKey:p.debug_info.session_key,decryptedData:p.debug_info.data}})}catch(a){}return{errMsg:`${d.api}:ok`,data:a}}if(e==k.NEED_CONFORM||global.online)return a(c,d,{imageUrl:p.appicon_url,appName:p.appname,scopeList:[p.scope]});const f=j.parseCgiErrorCode(e,q.errmsg);return'scope unauthorized'!=f||'webapi_getuserinfo'!=n.data.api_name||n.data.from_component||(await b(c)),{errMsg:`${d.api}:fail ${f}`}}},authorize:async function(a,b,c){const{scope:h}=b.args,n='scope.userLocation'===h[0];let o;if(n){const d=c(),e=d.simulator.appConfig;if(o=e&&e.permission&&e.permission['scope.userLocation']&&e.permission['scope.userLocation'].desc||'',!o)return a({type:l.SIMULATOR_SET_CONFIRM,data:{show:!0,content:m.config.NEED_PERMISSION_STATEMENT.format('authorize scope.userLocation'),showCancel:!1,confirmText:m.config.VIEW_DETAILS,callback:(a)=>{a&&!global.autoTest&&nw.Shell.openExternal('https://developers.weixin.qq.com/miniprogram/dev/framework/config.html#permission')}}}),{errMsg:`${b.api}:fail`}}const{body:p}=await g({url:`${i.jsAuthorizeURL}`,method:'post',body:JSON.stringify({scope:b.args.scope||[]}),needCheckErrCode:-1,needToken:1,needAppID:1}),q=p.baseresponse;if(q){const c=q.errcode;if(0==c)return{errMsg:`${b.api}:ok`,body:p};if(c==k.NEED_CONFORM)return await(async()=>new Promise((c,g)=>{n?r.push({fn:async()=>await d(a,b,{title:m.config.ASK_FOR_LOCATION_PERMISSION.format(p.appname),content:o}),resolve:c,reject:g}):r.push({fn:async()=>await e(a,b,{imageUrl:p.appicon_url,appName:p.appname,scopeList:p.scope_list}),resolve:c,reject:g}),2>r.length&&f()}))();const g=j.parseCgiErrorCode(c,q.errmsg);return{errMsg:`${b.api}:fail ${g}`}}return{errMsg:`${b.api}:fail system error`}},openWeRunSetting:async function(a,b){const{body:c}=await g({url:`${i.checkWeRunState}`,method:'post',body:JSON.stringify({appid:h.getProjectAppID()}),needToken:1,needAppID:1}),d=c.state;if(1==d)return{errMsg:`${b.api}:ok`};const e=c.wording||m.config.USER_NOT_OPEN_WECHAT_MOVEMENT;return a({type:l.SIMULATOR_SET_CONFIRM,data:{show:!0,content:e,showCancel:!1,confirmText:m.config.CLOSE}}),{errMsg:`${b.api}:fail ${e}`}},chooseInvoiceTitle:async function(a,b){a({type:l.SIMULATOR_SET_CHOOSEINVOICETITLE,data:{show:!0,callbackID:b.callbackID,api:b.api}})},addPhoneContact:async function(a,b){a({type:l.SIMULATOR_SET_ADDPHONECONTACT,data:{show:!0,callbackID:b.callbackID,api:b.api,contactData:_extends({},b.args)}})},openAddress:async function(a,b){a({type:l.SIMULATOR_SET_CHOOSEADDRESS,data:{show:!0,callbackID:b.callbackID,api:b.api}})},clearAuthorizeQueue(){r=[]}}}(require('lazyload'),require);