'use strict';!function(require,directRequire){const a=require('react'),b=require('prop-types'),c=require('url'),d=require('./41c99b908d0cb118c2a6fcf3c306663c.js'),e=require('./a15851ca252a104aad8b3fd3fc114574.js'),f=require('./e9e3fd38aeedddd6db73d1d015ff6952.js'),g=require('./72653d4b93cdd7443296229431a7aa9a.js'),h=require('./a1dd553cc059d528bb0ef56afed53968.js'),i=require('./919ad605b043ca39c480b04f2062eb9a.js'),j=require('./3bfffbe88b3d923921f851c0697974fe.js'),k=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),l=require('./2dfc6a3df6d6fc51266b293c8420e88b.js'),m=require('./common/locales/index.js'),n=require('./a78e6d6a87de1708226375ca4c320d76.js'),o=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),p=require('./d2baddafb02abd034d543c2a31ef97a0.js'),q=require('./f6cbcecf6ed9f533f6a506310d8f07b6.js'),r=require('./949d8235c744ced2a80121e4dba34c28.js'),s=require('./41168dca39589e852da6631126d0f94d.js'),t=require('./a7261ee5e1a26dddf8d07b048ad1c94d.js'),u=require('./87822abadd12d18b00ea00716f2410f6.js'),v=require('./ff946754202ecf377034d29daac7c8d9.js'),w=require('./84b183688a46c9e2626d3e6f83365e13.js'),{weappStoreFileReqular:x,weappTmpFileReqular:y,weappUsrFileReqular:z,weappOpendataFileRegular:A,weappStoreFilePathPrefix:B,weappTmpFilePathPrefix:C,weappUsrFilePathPrefix:D}=require('./6242f55dbdfe53c2f07b7a51568311f2.js'),{validType:E,tokenManager:F}=require('./dc244a5ba483ad6e0acd267d3b91b282.js'),G='darwin'===process.platform;let H={};class I extends a.Component{constructor(a){super(a),this._consolemessage=this.consolemessage.bind(this),this._onWebviewMessage=this.onWebviewMessage.bind(this),this.state={zIndex:'standby'==a.type?-1:0},this.consoleMsgQueue={}}componentDidMount(){const a=this.props,b=this.container,c=this.webviewID=a.info.id;this.context.isPopup&&this.adjustWindowSize();const d=this.webview=n.get('simulator',{id:c,width:a.width,height:a.height,dpr:a.dpr});d.needDebugger=1,this.props.muted&&d.setAudioMuted(!0),this.setWebviewHeight(),this.setUserAgentOverride(),'tip'==a.type?d.src=`html/weappabout.html?${c}`:(this.initEvent(),this.initDebuggeeEvent(),d.src=`http://127.0.0.1:${global.proxyPort}/aboutblank?${c}`),d.attach(b),e.register(c,this._onWebviewMessage),this.wxmlMessager=f.get('wxml_miniprogram'),this.traceMessage=f.get('trace_miniprogram'),global.online&&u.manager.addWebview(c,d._webview)}componentWillReceiveProps(a){if(a.jssdkCallbackInfo!=this.props.jssdkCallbackInfo){const{callbackID:b,res:c,webviewID:d}=a.jssdkCallbackInfo;d==a.info.id&&e.invokeCallback(d,b,c)}if(a.interfaceCallbackInfo!=this.props.interfaceCallbackInfo){const{data:b}=a.interfaceCallbackInfo;b&&b.webviewID==a.info.id&&this.handleInterfaceInvocation(a.interfaceCallbackInfo)}if(a.captureScreen!=this.props.captureScreen&&a.captureScreen.webviewID==this.webviewID&&setTimeout(()=>{this.captureScreen()}),(a.info.pathName!=this.props.info.pathName||a.info.forceLoad!=this.props.info.forceLoad&&a.info.pathName)&&setTimeout(()=>{this.loadPage()}),a.type!=this.props.type&&'standby'!=a.type&&this.setState({zIndex:0}),a.wxmlInspected!=this.props.wxmlInspected&&this.webview&&this.webview.setEmulationTouch(!a.wxmlInspected),(a.muted&&!this.props.muted||!a.muted&&this.props.muted)&&this.webview&&this.webview.setAudioMuted(a.muted),this.props.info.ready&&a.show!=this.props.show)if(clearTimeout(this.hideTimer),!a.show){try{this.props.appConfig.entryPagePath.match(/^(.+)\.html$/)[1]===this.props.info.pathName&&this.webview.captureVisibleRegion({format:'png'},(a)=>{this.props.projectActions.updateProjectCover({image:a})})}catch(a){g.error('fail: capture screen while leaving first page'+a.toString())}this.hideTimer=setTimeout(()=>{this.setState({zIndex:1})},200)}else this.setState({zIndex:2});a.height!=this.props.height&&(clearTimeout(this._setWebviewHeightTimer),this._setWebviewHeightTimer=setTimeout(()=>{this.context.isPopup&&this.adjustWindowSize(),this.setWebviewHeight()})),a.shareInfoShow!=this.props.shareInfoShow&&a.shareInfoShow&&a.show&&!a.info.htmlwebviewInfo&&this.webview.executeScript({code:'alert(\'GET_WEBVIEW_SCROLL_Y\' + window.scrollY);window.scrollTo(0,0);'},()=>{this.webview.captureVisibleRegion({format:'png'},(a)=>{this.props.simulatorActions.setShareDataURI(this.webviewID,a),this.webview.executeScript({code:`window.scrollTo(0,${this.webviewScrollY})`},()=>{this.webviewScrollY=void 0})})})}componentWillUnmount(){this.webview&&this.webview.detach(),global.online&&u.manager.removeWebview(this.props.info.id),this.props.simulatorActions.setDebuggee(void 0,this.webviewID,!1),e.unRegister(this.webviewID,this._onWebviewMessage)}adjustWindowSize(){}handleInterfaceInvocation(a){function b(a){t.invokeCallback({callbackID:c,data:a})}const{callbackID:c,method:d,data:e}=a;switch(d){case'getWebviewHTML':{this.documentReady?this.webview.executeScript({code:'document.body.innerHTML'},(a)=>{a&&a[0]?b(a[0]):b('')}):b('');break}case'getScreenShot':{this.webview.captureVisibleRegion({format:'png'},(a)=>{b(a)});break}}}captureScreen(){this.webview.captureVisibleRegion({format:'png'},(a)=>{const b=Buffer.from(a.replace('data:image/png;base64,',''),'base64'),c=q.copyFileDataToTemp(this.props.project,b,'.png'),{webviewID:d,callbackID:e}=this.props.captureScreen;this.props.simulatorActions.assdkCallback({callbackID:e,res:{errMsg:'captureScreen:ok',tempFilePath:c}})})}setWebviewHeight(){let a=this.props.width/this.props.deviceScale,b=this.props.height/this.props.deviceScale;this.props.popup&&(b=this.props.height,a=this.props.width),this.webview.setAttribute('style',`position:absolute;height:${b}px;width:${a}px;`);try{this.webview.setOffset({height:this.props.height,width:this.props.width,dpr:this.props.dpr})}catch(a){}}reload(){this.documentReady=!1,this.alreadyInit=!1;const a=this.webview;this.setUserAgentOverride(),a.src=`http://127.0.0.1:${global.proxyPort}/__pageframe__/pageframe.html`}setUserAgentOverride(){const a=F.getSessionToken(E.UA_TOKEN);let b=this.props.ua.replace('{{webviewID}}',this.webviewID);b+=` miniprogram port/${global.messageCenterPort} token/${a}`,this.webview.setUserAgentOverride(b)}async animateWebviewTransition(a){return new Promise((b)=>{if(!this.container)return;let{top:c,left:d,height:e,width:f}=this.container.getBoundingClientRect();if(e/=this.props.deviceScale,f/=this.props.deviceScale,c=this.props.top,d=0,'enter'===a){const a=this.container.style.cssText,g=`position:fixed; width:${f}px; height:${e}px; top:${c}px; left:${d}px;`;this.container.style.cssText='z-index: 2;'+g,this.container.style.transform=`translate(${f}px, 0)`;const h=()=>{this.container.removeEventListener('transitionend',h),this.container.style.cssText=a,this.setState({zIndex:this.props.show?1:0},b)};this.container.addEventListener('transitionend',h);const i=this.context.window||global.Win;i.window.requestAnimationFrame(()=>{this.container&&(this.container.style.transition='all linear 0.2s',this.container.style.transform='translate(0,0)')}),this.container.offsetHeight}else if('exit'===a){const a=this.container.style.cssText,g=`position:fixed; width:${f}px; height:${e}px; top:${c}px; left:${d}px;`;this.container.style.cssText='z-index: 2;'+g,this.container.style.transform='translate(0, 0)';const h=()=>{this.container.removeEventListener('transitionend',h),this.container.style.cssText=a,this.setState({zIndex:this.props.show?1:0},b)};this.container.addEventListener('transitionend',h);const i=this.context.window||global.Win;i.window.requestAnimationFrame(()=>{this.container&&(this.container.style.transition='all linear 0.2s',this.container.style.transform=`translate(${f}px,0)`)}),this.container.offsetHeight}})}async loadPage(){const a=this.webview;if(!this.webview||!this.props.info||!this.props.info.pathName||!this.documentReady)return;const b=this.props.info;if(b.pageNotFound&&!b.forceLoad)return void h.triggerOnEvent({eventName:'onPageNotFound',data:{path:b.pathName,query:b.query,isEntryPage:b.isEntryPage},webviewID:this.webviewID});this.setWebviewHeight();const d=b.pathName;a.setAttribute('route',d);const e=c.parse(a.src);e.pathname=`__pageframe__/${d}`;const f=c.format(e);let g='';try{g=await p(this.props.project,d)}catch(a){return void l.display({command:k.DISPLAY_ERROR,data:{error:a}})}const i=w.escapeQuot(w.escapeQuot(f,'\''),'`');g=`var script = document.createElement('script')
      script.text = \`
        history.pushState('','', '${i}')
        ${w.escapeQuot(g,'`')};
      \`
      document.head.appendChild(script)`,a.executeScript({code:g},()=>{Date.now();this.props.simulatorActions.setWebviewReady(this.webviewID,!0),this.onWebviewReady(),this.initReadyTimer=setTimeout(()=>{this.initReady()},500)}),this.traceMessage.triggerOnEvent('TRACE_EVENT',{metadata:{webviewID:this.webviewID,pathName:d}})}consolemessage(a){const b=a.message;this.consoleMsgQueue[b]||(this.consoleMsgQueue[b]=!0,i(a))}onWebviewReady(){this.props.muted&&setTimeout(()=>{this.webview.setAudioMuted(this.props.muted)},100)}onWebviewMessage(a){let b={};try{b=JSON.parse(a)}catch(b){return void g.error(`onWebviewMessage parse ${a} error ${b}`)}if('WEBVIEW_PUBLISH'==b.command)e.publish(a);else if('WEBVIEW_INVOKE'==b.command){const a=b.data.api;if('initReady'==a)this.initReady();else if('traceEvent'===a)return void this.traceMessage.triggerOnEvent('TRACE_EVENT',{args:b.data.args,webviewID:this.webviewID});const c=b.data.callbackID;this.props.jssdkActions.exec(b.data,this.webviewID).then((a)=>{a&&e.invokeCallback(this.webviewID,c,a)})}else'PULLDOWN_REFRESH'==b.command&&h.triggerOnEvent({eventName:'onPullDownRefresh',data:{},webviewID:this.webviewID})}initReady(){if(clearTimeout(this.initReadyTimer),this.alreadyInit)return;this.alreadyInit=!0,setTimeout(()=>{b()},20);const a=-1==this.props.info.tabbarIndex;var b=()=>{a?(this.animateWebviewTransition('enter'),this.props.simulatorActions.setAppRoute({status:'done'}),this.props.toolbarActions.setDeviceRotatedBeforeRoute(!1)):(this.setState({zIndex:this.props.show?2:1}),this.props.simulatorActions.setAppRoute({status:'done'}),this.props.toolbarActions.setDeviceRotatedBeforeRoute(!1)),setTimeout(()=>{this.tryCaptureScreenForBackground()},5e3)}}tryCaptureScreenForBackground(){if(!global.online){this._captureTryCount||(this._captureTryCount=0),this._captureTryCount++;try{this.props.appConfig.entryPagePath.match(/^(.+)\.html$/)[1]===this.props.info.pathName&&this.webview.captureVisibleRegion({format:'png'},async(a)=>{try{const b=await s({taskName:'isSameColorImage',config:{type:'dataURI',format:'png'},dataStr:a,maxTimeout:60000,useBackup:!1,downgrade:!0});if(b.error)throw new Error(b.error);if(b.same){if(3<this._captureTryCount)return;setTimeout(this.tryCaptureScreenForBackground.bind(this),5e3)}else this.props.projectActions.updateProjectCover({image:a})}catch(a){g.info('process capture screen failure with err: '+a.toString())}})}catch(a){g.info('chrome capture screen failure with err: '+a.toString())}}}initDebuggeeEvent(){global.useChromeRemoteDebugProtocal&&(this.webview.onDebuggeeEvent=(a,b,c={})=>{if('DOM.inlineStyleInvalidated'!==b&&'DOM.characterDataModified'!==b&&('Overlay.nodeHighlightRequested'!==b||'Overlay.nodeHighlightRequested'!==H.method||c.nodeId!==H.nodeId)){H='Overlay.nodeHighlightRequested'===b?{method:b,nodeId:c.nodeId}:{};({"DOM.documentUpdated":!0,"DOM.childNodeCountUpdated":!0,"DOM.setChildNodes":!0,"DOM.childNodeRemoved":!0,"DOM.childNodeInserted":!0,"DOM.attributeRemoved":!0,"DOM.attributeModified":!0,"Overlay.inspectNodeRequested":!0,"DOM.nodeHighlightRequested":!0,"Overlay.nodeHighlightRequested":!0})[b]&&this.wxmlMessager.triggerOnEvent('ON_EVENT',{debuggee:a,method:b,params:c})}}),this.webview.onDebuggeeDetach=(a)=>{this.props.simulatorActions.setDebuggee(a,this.webviewID,!1)},this.webview.onDebuggeeAttach=(a)=>{this.props.simulatorActions.setDebuggee(a,this.webviewID,!0),this.reload()}}initEvent(){const a=this.webview;a.on('consolemessage',this._consolemessage),a.on('dialog',(a)=>{a.preventDefault();const b=a.messageType||'',c=a.messageText,d=a.dialog;return'alert'===b?(d.ok(''),void('DOCUMENT_READY'==c?(this.documentReady=!0,this.loadPage()):0==c.indexOf('GET_WEBVIEW_SCROLL_Y')?this.webviewScrollY=c.replace('GET_WEBVIEW_SCROLL_Y',''):0==c.indexOf('\u8FDB\u5165\u5BA2\u670D\u4F1A\u8BDD')&&this.props.simulatorActions.setConfirm({show:!0,content:c,showCancel:!1,confirmText:m.config.RETURN}))):'confirm'===b?void d.ok(''):'prompt'===b?void(c===k.GET_MESSAGE_TOKEN?d.ok(v.getToken(['WEBVIEW','DEVTOOLS'])):d.ok('')):void 0}),a.on('mouseleave',()=>{a.setEmulationTouch(!1)}),a.on('mouseenter',()=>{this.props.wxmlInspected||a.setEmulationTouch(!0)}),this.initRequestListener(a)}initRequestListener(a){a.request;this.webview.onRequestErrorOccurred=(a)=>{const{type:b}=a;'script'===b||'main_frame'===b||'net::ERR_ABORTED'===a.error||'image'==a.type&&`http://127.0.0.1:${global.proxyPort}/__pageframe__/${this.props.info.pathName}`==a.url||l.display({command:k.DISPLAY_ERROR,data:{error:{code:r.WEBVIEW_NETWORK_ERROR,details:a}}})},this.webview.onBeforeRequest=(a)=>{const b=a.url;if(0==b.indexOf(`http://127.0.0.1:${global.proxyPort}/`)){const a=c.parse(b),d=a.pathname.replace(/^\//,'');if('aboutblank'!=d&&'favicon.ico'!=d&&!/^__pageframe__\//.test(d)&&0!==d.indexOf(B)&&0!==d.indexOf(C)&&0!==d.indexOf(D)&&0!==d.indexOf('experience'))return{redirectUrl:`http://127.0.0.1:${global.proxyPort}/__pageframe__/${d}`}}else{if(x.test(b)||y.test(b)||z.test(b)||A.test(b))return{redirectUrl:b.replace(/^https?:\/\//,`$&127.0.0.1:${global.proxyPort}/`)};if(!/^https?:\/\//i.test(b))return{cancel:!0};if('main_frame'===a.type&&/^chrome-extension:\/\//.test(b))return{cancel:!0}}},this.webview.onRequestBeforeSendHeaders=(a)=>{const b=a.url;if(0!=b.indexOf(`http://127.0.0.1:${global.proxyPort}/`)&&!/favicon\.ico$/.test(b)&&'none'==this.props.networkType)return l.display({command:k.DISPLAY_ERROR,data:{title:m.config.NO_NETWORK_TIPS_TITLE,error:{message:m.config.NO_NETWORK_TIPS_CONTENT.format(b)}}}),{cancel:!0};if(0==b.indexOf(`http://127.0.0.1:${global.proxyPort}/__pageframe__`)){const a=c.parse(b),d=a.pathname.replace(/^\/__pageframe__\//,''),e=o.checkIsInSubPackage(this.props.appConfig,d),f=o.checkIsInSubPackage(this.props.appConfig,this.props.info.pathName);if(e&&e!=f)return l.display({command:k.DISPLAY_ERROR,data:{title:m.config.RESOURCE_RELATIVE_TIPS_TITLE,error:{message:m.config.RESOURCE_RELATIVE_TIPS_CONTENT.format(d)}}}),{cancel:!0}}const d=a.requestHeaders||[],e=d.findIndex((a)=>'cookie'===a.name.toLowerCase());d.splice(e,1);for(let b=0;b<d.length;++b)if('Referer'===d[b].name){const a=j.getProjectAppID();d[b].value=`https://servicewechat.com/${a}/devtools/page-frame.html`}return{requestHeaders:a.requestHeaders}},this.webview.onRequestCompleted=(a)=>{const{type:b,statusCode:c}=a;if('script'!==b&&'main_frame'!==b&&400<=c){if('image'==a.type&&`http://127.0.0.1:${global.proxyPort}/__pageframe__/${this.props.info.pathName}`==a.url)return;l.display({command:k.DISPLAY_ERROR,data:{error:{code:r.WEBVIEW_NETWORK_ERROR,details:a}}})}}}handleH5WebviewEvent(a,b){a&&b&&e.triggerOnEvent({eventName:a,data:b,webviewID:this.webviewID})}render(){const b=this.props,c={position:'absolute',width:b.width,height:b.height,top:b.top,zIndex:this.state.zIndex},e=b.info.htmlwebviewInfo,f=this.handleH5WebviewEvent;return a.createElement('div',{className:'webview',ref:(a)=>this.container=a,style:c},e?a.createElement(d,{webviewID:b.info.id,htmlId:e.htmlId,url:e.src||'',originUrl:e.originUrl||'',cangoback:e.cangoback,width:e.position&&e.position.width||b.width,height:e.position&&e.position.height||b.height,left:e.position&&e.position.left||0,top:e.position&&e.position.top||0,handleH5WebviewEvent:f}):null)}}I.contextTypes={isPopup:b.bool,window:b.object},module.exports=I}(require('lazyload'),require);